
.. DO NOT EDIT.
.. THIS FILE WAS AUTOMATICALLY GENERATED BY SPHINX-GALLERY.
.. TO MAKE CHANGES, EDIT THE SOURCE PYTHON FILE:
.. "gallery/vortex.py"
.. LINE NUMBERS ARE GIVEN BELOW.

.. only:: html

    .. note::
        :class: sphx-glr-download-link-note

        :ref:`Go to the end <sphx_glr_download_gallery_vortex.py>`
        to download the full example code

.. rst-class:: sphx-glr-example-title

.. _sphx_glr_gallery_vortex.py:

Visualizing optical flow in napari.

Adapted from the scikit-image gallery [1]_.

In napari, we can show the flowing vortex as an additional dimension in the
image, visible by moving the slider.

.. tags:: visualization-advanced, layers

.. [1] https://scikit-image.org/docs/stable/auto_examples/registration/plot_opticalflow.html

.. GENERATED FROM PYTHON SOURCE LINES 12-18

.. code-block:: default

    import numpy as np
    from skimage.data import vortex
    from skimage.registration import optical_flow_ilk

    import napari








.. GENERATED FROM PYTHON SOURCE LINES 19-20

First, we load the vortex image as a 3D array. (time, row, column)

.. GENERATED FROM PYTHON SOURCE LINES 20-23

.. code-block:: default


    vortex_im = np.asarray(vortex())








.. GENERATED FROM PYTHON SOURCE LINES 24-27

We compute the optical flow using scikit-image. (Note: as of
scikit-image 0.21, there seems to be a transposition of the image in
the output, which we account for later.)

.. GENERATED FROM PYTHON SOURCE LINES 27-30

.. code-block:: default


    u, v = optical_flow_ilk(vortex_im[0], vortex_im[1], radius=15)








.. GENERATED FROM PYTHON SOURCE LINES 31-32

Compute the flow magnitude, for visualization.

.. GENERATED FROM PYTHON SOURCE LINES 32-35

.. code-block:: default


    magnitude = np.sqrt(u ** 2 + v ** 2)








.. GENERATED FROM PYTHON SOURCE LINES 36-38

Create a viewer, add the vortex frames, and overlay the flow
magnitude.

.. GENERATED FROM PYTHON SOURCE LINES 38-42

.. code-block:: default


    viewer, vortex_layer = napari.imshow(vortex_im)
    mag_layer = viewer.add_image(magnitude, colormap='magma', opacity=0.3)




.. image-sg:: /gallery/images/sphx_glr_vortex_001.png
   :alt: vortex
   :srcset: /gallery/images/sphx_glr_vortex_001.png
   :class: sphx-glr-single-img





.. GENERATED FROM PYTHON SOURCE LINES 43-46

Finally, we subsample the vector field to display it — it's too
messy otherwise! And we transpose the rows/columns axes to match the
current scikit-image output.

.. GENERATED FROM PYTHON SOURCE LINES 46-70

.. code-block:: default


    nvec = 21
    nr, nc = magnitude.shape
    step = max(nr//nvec, nc//nvec)
    offset = step // 2
    usub = u[offset::step, offset::step]
    vsub = v[offset::step, offset::step]

    vectors_field = np.transpose(  # transpose required — skimage bug?
            np.stack([usub, vsub], axis=-1),
            (1, 0, 2),
            )

    flow_layer = viewer.add_vectors(
            vectors_field,
            name='optical flow',
            scale=[step, step],
            translate=[offset, offset],
            edge_width=0.3,
            length=0.3,
            )

    if __name__ == '__main__':
        napari.run()


.. rst-class:: sphx-glr-script-out

.. code-block:: pytb

    Traceback (most recent call last):
      File "/home/runner/work/docs/docs/docs/examples/vortex.py", line 59, in <module>
        flow_layer = viewer.add_vectors(
      File "/opt/hostedtoolcache/Python/3.10.13/x64/lib/python3.10/site-packages/napari/components/viewer_model.py", line 5, in add_vectors
        import os
      File "/opt/hostedtoolcache/Python/3.10.13/x64/lib/python3.10/_collections_abc.py", line 1128, in append
        self.insert(len(self), value)
      File "/opt/hostedtoolcache/Python/3.10.13/x64/lib/python3.10/site-packages/napari/components/layerlist.py", line 194, in insert
        super().insert(index, new_layer)
      File "/opt/hostedtoolcache/Python/3.10.13/x64/lib/python3.10/site-packages/napari/utils/events/containers/_selectable_list.py", line 71, in insert
        self.selection.active = value
      File "/opt/hostedtoolcache/Python/3.10.13/x64/lib/python3.10/site-packages/napari/utils/events/containers/_selection.py", line 108, in active
        self.events.active(value=value)
      File "/opt/hostedtoolcache/Python/3.10.13/x64/lib/python3.10/site-packages/napari/utils/events/event.py", line 771, in __call__
        self._invoke_callback(cb, event if pass_event else None)
      File "/opt/hostedtoolcache/Python/3.10.13/x64/lib/python3.10/site-packages/napari/utils/events/event.py", line 809, in _invoke_callback
        _handle_exception(
      File "/opt/hostedtoolcache/Python/3.10.13/x64/lib/python3.10/site-packages/napari/utils/events/event.py", line 796, in _invoke_callback
        cb(event)
      File "/opt/hostedtoolcache/Python/3.10.13/x64/lib/python3.10/site-packages/napari/_qt/layer_controls/qt_layer_controls_container.py", line 130, in _display
        controls = self.widgets[layer]
    KeyError: <Vectors layer 'optical flow' at 0x7fcf2cbf9660>





.. _sphx_glr_download_gallery_vortex.py:

.. only:: html

  .. container:: sphx-glr-footer sphx-glr-footer-example




    .. container:: sphx-glr-download sphx-glr-download-python

      :download:`Download Python source code: vortex.py <vortex.py>`

    .. container:: sphx-glr-download sphx-glr-download-jupyter

      :download:`Download Jupyter notebook: vortex.ipynb <vortex.ipynb>`


.. only:: html

 .. rst-class:: sphx-glr-signature

    `Gallery generated by Sphinx-Gallery <https://sphinx-gallery.github.io>`_
