
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
    <link type="image/svg+xml" href="../_static/favicon/logo-silhouette-dark-light.svg" rel="icon">
    <link sizes="any" href="../_static/favicon/logo-silhouette-192.png" rel="icon" type="image/png">
    <link rel="apple-touch-icon" sizes="180x180" href="../_static/favicon/logo-noborder-180.png" type="image/png">
    <title>NAP-4: Asynchronous slicing &#8212; napari</title>
  <link rel="stylesheet" href="../_static/fa/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/webfonts/fa-brands-400.woff2">
  <link href="../_static/styles/theme.css" rel="stylesheet">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow:ital,wght@0,400;0,500;0,600;0,700;1,400;1,500;1,600;1,700&family=JetBrains+Mono:ital,wght@0,400;0,600;0,700;1,600&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/napari-sphinx-theme.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-binder.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-dataframe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sg_gallery-rendered-html.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css" />
    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/design-tabs.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="NAP-5 — New logo (2022)" href="5-new-logo.html" />
    <link rel="prev" title="NAP-3 — Spaces" href="3-spaces.html" />
    <script async defer data-domain="napari.org" src="https://plausible.io/js/plausible.js"></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    

  </head>
  <body>
    
    <nav class="navbar navbar-light navbar-expand-lg bg-light fixed-top bd-navbar" id="navbar-main"><div class="container-xl">

  <div id="navbar-start">
    
    <!-- A small template snippet for theme testing -->
<a class="navbar-brand" href="../index.html">
  napari
</a>
    
  </div>

  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar-collapsible" aria-controls="navbar-collapsible" aria-expanded="false" aria-label="Toggle navigation">
    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M20 2H0" stroke="black" stroke-width="3"/>
  <path d="M20 10H0" stroke="black" stroke-width="3"/>
  <path d="M20 18H0" stroke="black" stroke-width="3"/>
</svg>
  </button>

  
  <div id="navbar-collapsible" class="col-lg-9 collapse navbar-collapse">
    <div id="navbar-center" class="mr-auto">
      
      <div class="navbar-center-item">
        <ul id="navbar-main-elements" class="navbar-nav">
    <li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../usage.html">
  Usage
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../plugins/index.html">
  Plugins
 </a>
</li>

<li class="toctree-l1 current active nav-item">
 <a class="reference internal nav-link" href="../community/index.html">
  Community
 </a>
</li>

<li class="toctree-l1 nav-item">
 <a class="reference internal nav-link" href="../api/index.html">
  API Reference
 </a>
</li>

    
    <li class="nav-item">
        <a class="nav-link nav-external" href="https://napari-hub.org">napari hub<i class="fas fa-external-link-alt"></i></a>
    </li>
    
</ul>
      </div>
      
    </div>

    <div id="navbar-end">
      
      <div class="navbar-end-item">
        <div class="dropdown" id="version_switcher">
    <button type="button" class="btn btn-primary btn-sm navbar-btn dropdown-toggle" id="version_switcher_button" data-toggle="dropdown">
        <span>version <span id="version_switcher_button_text">0.4.18</span></span>

        <svg class="version-switcher-chevron" width="17" height="10" viewBox="0 0 17 10" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M1.27197 1.5L8.34304 8.57107L15.4141 1.5" stroke="black" stroke-width="2"/>
        </svg>
    </button>
    <div id="version_switcher_menu" class="dropdown-menu list-group-flush py-0" aria-labelledby="version_switcher_button">
    <!-- dropdown will be populated by javascript on page load -->
    </div>
</div>

<!-- NOTE: this JS must live here (not in our global JS file) because it relies
     on being processed by Jinja before it is run (specifically for replacing
     variables naps/4-async-slicing and {'json_url': 'https://napari.org/dev/_static/version_switcher.json', 'version_match': '0.4.18'}.
-->

<script type="text/javascript">
// Check if corresponding page path exists in other version of docs
// and, if so, go there instead of the homepage of the other docs version
function checkPageExistsAndRedirect(event) {
    const currentFilePath = "naps/4-async-slicing.html",
          tryUrl = event.target.getAttribute("href");
    let otherDocsHomepage = tryUrl.replace(currentFilePath, "");
    $.ajax({
        type: 'HEAD',
        url: tryUrl,
        // if the page exists, go there
        success: function() {
            location.href = tryUrl;
        }
    }).fail(function() {
        location.href = otherDocsHomepage;
    });
    // this prevents the browser from following the href of the clicked node
    // (which is fine because this function takes care of redirecting)
    return false;
}

// Populate the version switcher from the JSON config file
(function () {
    $.getJSON("https://napari.org/dev/_static/version_switcher.json", function(data, textStatus, jqXHR) {
        const currentFilePath = "naps/4-async-slicing.html";
        // create links to the corresponding page in the other docs versions
        $.each(data, function(index, entry) {
            // if no custom name specified (e.g., "latest"), use version string
            if (!("name" in entry)) {
                entry.name = entry.version;
            }
            // create the node
            const node = document.createElement("a");
            node.setAttribute("class", "list-group-item list-group-item-action py-1");
            node.textContent = `${entry.name}`;
            node.setAttribute("href", `${entry.url}${currentFilePath}`);
            // on click, AJAX calls will check if the linked page exists before
            // trying to redirect, and if not, will redirect to the homepage
            // for that version of the docs.
            node.onclick = checkPageExistsAndRedirect;
            // Add dataset values for the version and name in case people want
            // to apply CSS styling based on this information.
            node.dataset["versionName"] = entry.name;
            node.dataset["version"] = entry.version;

            $("#version_switcher_menu").append(node);
            // replace dropdown button text with the preferred display name of
            // this version, rather than using sphinx's 0.4.18 variable.
            // also highlight the dropdown entry for the currently-viewed
            // version's entry
            if (entry.version == "0.4.18") {
                node.classList.add("active");
                let btn = document.getElementById("version_switcher_button");
                btn.innerText = btn.dataset["activeVersionName"] = entry.name;
                btn.dataset["activeVersion"] = entry.version;
            }
        });
    });
})();
</script>
      </div>
      
      <div class="navbar-end-item">
        <ul id="navbar-icon-links" class="navbar-nav" aria-label="Icon Links">
        <li class="nav-item">
          <a class="nav-link" href="https://github.com/napari/napari" rel="noopener" target="_blank" title="GitHub"><span><i class="fab fa-github-square"></i></span>
            <label class="sr-only">GitHub</label></a>
        </li>
      </ul>
      </div>
      
    </div>
  </div>
</div>
    </nav>
    

    <div class="napari-page">
        
          
          <!-- Only show if we have sidebars configured, else just a small margin  -->
          <div class="bd-sidebar">
            <div class="sidebar-start-items"><form
  class="search"
  action="../search.html"
  method="get"
>
  <input
    type="search"
    name="q"
    placeholder="search"
    aria-label="search"
    autocomplete="off"
  />

  <svg
    width="16"
    height="16"
    viewBox="0 0 16 16"
    fill="none"
    xmlns="http://www.w3.org/2000/svg"
  >
    <path
      d="M8.32001 7.67998L0.746674 15.2533M10.6667 9.59998C13.0133 9.59998 14.9333 7.67998 14.9333 5.33332C14.9333 2.98665 13.0133 1.06665 10.6667 1.06665C8.32001 1.06665 6.40001 2.98665 6.40001 5.33332C6.40001 7.67998 8.32001 9.59998 10.6667 9.59998Z"
      stroke="black"
      stroke-width="2"
    />
  </svg>
  </button>
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <div class="bd-toc-item active">
    <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../community/mission_and_values.html">
   Mission and Values
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../community/team.html">
   About the project and team
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../community/code_of_conduct.html">
   Code of Conduct
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../community/code_of_conduct_reporting.html">
   Handling Code of Conduct reports
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../community/governance.html">
   Governance model
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../community/working_groups.html">
   Working groups
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../community/meeting_schedule.html">
   Meeting schedule
  </a>
 </li>
 <li class="toctree-l1 current active has-children">
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <img src="../_static/icons/sidebar-triangle.png"/>
  </label>
  <a class="reference internal" href="../developers/index.html">
   Contributing resources
  </a>
  <ul class="current">
   <li class="toctree-l2">
    <a class="reference internal" href="../developers/contributing.html">
     Contributing guide
    </a>
   </li>
   <li class="toctree-l2 current active has-children">
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
    <label for="toctree-checkbox-2">
     <img src="../_static/icons/sidebar-triangle.png"/>
    </label>
    <a class="reference internal" href="index.html">
     napari Advancement Proposals (NAPs)
    </a>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="0-nap-process.html">
       NAP 0 — Purpose and Process
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="1-institutional-funding-partners.html">
       NAP-1 — Institutional and Funding Partners
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="2-conda-based-packaging.html">
       NAP-2 — Distributing napari with conda-based packaging
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="3-spaces.html">
       NAP-3 — Spaces
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       NAP-4: Asynchronous slicing
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="5-new-logo.html">
       NAP-5 — New logo (2022)
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="6-contributable-menus.html">
       NAP-6 — Contributable Menus
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="template.html">
       NAP-X — Template and Instructions
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
    <label for="toctree-checkbox-3">
     <img src="../_static/icons/sidebar-triangle.png"/>
    </label>
    <a class="reference internal" href="../developers/documentation/index.html">
     Contributing Documentation
    </a>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="../developers/documentation/docs_template.html">
       Docs template
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../developers/translations.html">
     Translations
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../developers/core_dev_guide.html">
     Core Developer guide
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../developers/release.html">
     Release guide
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../developers/testing.html">
     Testing
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../developers/profiling.html">
     Profiling
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../developers/benchmarks.html">
     Benchmarks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../developers/packaging.html">
     Packaging
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
  <label for="toctree-checkbox-4">
   <img src="../_static/icons/sidebar-triangle.png"/>
  </label>
  <a class="reference internal" href="../release/index.html">
   Release notes
  </a>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_18.html">
     napari 0.4.18
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_17.html">
     napari 0.4.17
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_16.html">
     napari 0.4.16
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_15.html">
     napari 0.4.15
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_14.html">
     napari 0.4.14
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_13.html">
     napari 0.4.13
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_12.html">
     napari 0.4.12
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_11.html">
     napari 0.4.11
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_10.html">
     napari 0.4.10
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_9.html">
     napari 0.4.9
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_8.html">
     napari 0.4.8
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_7.html">
     napari 0.4.7
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_6.html">
     napari 0.4.6
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_5.html">
     napari 0.4.5
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_4.html">
     napari 0.4.4
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_3.html">
     napari 0.4.3
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_2.html">
     napari 0.4.2
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_1.html">
     napari 0.4.1
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_4_0.html">
     napari 0.4.0
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_3_8.html">
     napari 0.3.8
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_3_7.html">
     napari 0.3.7
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_3_6.html">
     napari 0.3.6
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_3_5.html">
     napari 0.3.5
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_3_4.html">
     napari 0.3.4
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_3_3.html">
     napari 0.3.3
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_3_2.html">
     napari 0.3.2
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_3_1.html">
     napari 0.3.1
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_3_0.html">
     napari 0.3.0
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_2_12.html">
     napari 0.2.12
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_2_11.html">
     napari 0.2.11
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_2_10.html">
     napari 0.2.10
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_2_9.html">
     napari 0.2.9
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_2_8.html">
     napari 0.2.8
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_2_7.html">
     napari 0.2.7
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_2_6.html">
     napari 0.2.6
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_2_5.html">
     napari 0.2.5
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_2_4.html">
     napari 0.2.4
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_2_3.html">
     napari 0.2.3
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_2_1.html">
     napari 0.2.1
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_2_0.html">
     napari 0.2.0
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_1_5.html">
     napari 0.1.5
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_1_3.html">
     napari 0.1.3
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../release/release_0_1_0.html">
     napari 0.1.0
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
  <label for="toctree-checkbox-5">
   <img src="../_static/icons/sidebar-triangle.png"/>
  </label>
  <a class="reference internal" href="../roadmaps/index.html">
   Roadmaps
  </a>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../roadmaps/0_4.html">
     Roadmap 0.4
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../roadmaps/0_3_retrospective.html">
     Roadmap 0.3 Retrospective
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../roadmaps/0_3.html">
     Roadmap 0.3
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../community/licensing.html">
   Licensing
  </a>
 </li>
</ul>

  </div>
</nav>
            </div>
            <div class="sidebar-end-items">
            </div>
          </div>
          
        

        
        <div class="bd-toc">
          
            
            <div class="toc-item">
              
<div class="tocsection onthispage mt-5 pt-1 pb-3">
    On this page
</div>

<nav id="bd-toc-nav">
    <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#abstract">
   Abstract
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#motivation-and-scope">
   Motivation and scope
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#goals">
     Goals
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#keep-responding-when-slicing-slow-data">
       1. Keep responding when slicing slow data
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#clean-up-slice-state-and-logic-in-layers">
       2. Clean up slice state and logic in layers
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#measure-slicing-latencies-on-representative-examples">
       3. Measure slicing latencies on representative examples
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#non-goals">
     Non-goals
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#related-work">
   Related work
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#existing-slice-logic">
     Existing slice logic
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#existing-slice-state">
     Existing slice state
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#input-state">
       Input state
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#output-state">
       Output state
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#detailed-description">
   Detailed description
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#request-and-response">
     Request and response
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#layer-methods">
     Layer methods
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#layer-slicer">
     Layer slicer
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hooking-up-the-viewer">
     Hooking up the viewer
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#implementation">
   Implementation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#backward-compatibility">
   Backward compatibility
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#breaks-synchronous-slicing-behavior">
     Breaks synchronous slicing behavior
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#store-existing-slice-state-on-layer">
     Store existing slice state on layer
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#future-work">
   Future work
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#render-each-slice-as-soon-as-it-is-ready">
     Render each slice as soon as it is ready
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#alternatives">
   Alternatives
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#extend-the-existing-experimental-async-code">
     Extend the existing experimental async code
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#just-call-set-view-slice-or-refresh-asynchronously">
     Just call
     <code class="docutils literal notranslate">
      <span class="pre">
       set_view_slice
      </span>
     </code>
     or
     <code class="docutils literal notranslate">
      <span class="pre">
       refresh
      </span>
     </code>
     asynchronously
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#just-access-data-asynchronously">
     Just access
     <code class="docutils literal notranslate">
      <span class="pre">
       data
      </span>
     </code>
     asynchronously
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#use-qthread-and-similar-utilities-instead-of-concurrent-futures">
     Use
     <code class="docutils literal notranslate">
      <span class="pre">
       QThread
      </span>
     </code>
     and similar utilities instead of
     <code class="docutils literal notranslate">
      <span class="pre">
       concurrent.futures
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#use-asyncio-package-instead-of-concurrent-futures">
     Use
     <code class="docutils literal notranslate">
      <span class="pre">
       asyncio
      </span>
     </code>
     package instead of
     <code class="docutils literal notranslate">
      <span class="pre">
       concurrent.futures
      </span>
     </code>
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#slice-from-vispy-layer-instead-of-viewer-model">
     Slice from vispy layer instead of viewer model
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#discussion">
   Discussion
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references-and-footnotes">
   References and footnotes
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#copyright">
   Copyright
  </a>
 </li>
</ul>

</nav>
            </div>
            
            <div class="toc-item">
              
            </div>
            
          
        </div>
        

        
        
          
        
        <main class="col-md-9 col-xl-7 bd-content" role="main">
            
            <div>
              
  <section class="tex2jax_ignore mathjax_ignore" id="nap-4-asynchronous-slicing">
<span id="nap-4-async-slicing"></span><h1>NAP-4: Asynchronous slicing<a class="headerlink" href="#nap-4-asynchronous-slicing" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Author</dt>
<dd class="field-odd"><p>Andy Sweet &lt;<a class="reference external" href="mailto:andrewdsweet&#37;&#52;&#48;gmail&#46;com">andrewdsweet<span>&#64;</span>gmail<span>&#46;</span>com</a>&gt;, Jun Xi Ni, Eric Perlman, Kim Pevey</p>
</dd>
<dt class="field-even">Created</dt>
<dd class="field-even"><p>2022-06-23</p>
</dd>
<dt class="field-odd">Resolution</dt>
<dd class="field-odd"><p><a class="reference external" href="https://github.com/napari/napari/pull/5052">https://github.com/napari/napari/pull/5052</a></p>
</dd>
<dt class="field-even">Resolved</dt>
<dd class="field-even"><p>2022-09-19</p>
</dd>
<dt class="field-odd">Status</dt>
<dd class="field-odd"><p>Accepted</p>
</dd>
<dt class="field-even">Type</dt>
<dd class="field-even"><p>Standards Track</p>
</dd>
<dt class="field-odd">Version effective</dt>
<dd class="field-odd"><p>0.5</p>
</dd>
</dl>
<section id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>Slicing a layer in napari generates a partial view of the layer’s data based
on the dimension slider positions and the current field of view.</p>
<p>This project has two major goals.</p>
<ol class="arabic simple">
<li><p>Slice layers asynchronously to keep napari responsive while allowing for slow slicing.</p></li>
<li><p>Improve the logic of slicing layers to help developers better understand how it works and unlock new feature development.</p></li>
</ol>
<p>We propose a lock-free asynchronous solution that uses Python’s built-in
<code class="docutils literal notranslate"><span class="pre">concurrent.futures</span></code> module and exploits napari’s main event loop.
For each slice, an immutable shallow copy of all the required input to slicing is
collected on the main thread and is then processed on a separate single-threaded executor.
When the slice task is finished, we notify vispy and Qt objects back on the main thread
so they can be safely updated.
This approach allows us to gradually introduce asynchronous slicing to napari
layer by layer without breaking other functionality that relies on existing layer slice state.</p>
</section>
<section id="motivation-and-scope">
<h2>Motivation and scope<a class="headerlink" href="#motivation-and-scope" title="Permalink to this headline">¶</a></h2>
<p>Currently, all slicing in napari is performed synchronously.
For example, if a dimension slider is moved, napari waits to slice a layer
before updating the canvas. When slicing layers is slow, this blocking behavior
makes interacting with data difficult and napari may be reported as not responding
by the host operating system.</p>
<p><img alt="The napari viewer displaying a 2D slice of a 3D multi-resolution electron microscopy image stored remotely. Dragging the slider changes the 2D slice, but the slider position and canvas updates are slow and napari stops responding." src="https://i.imgur.com/cAJxkLq.gif" /></p>
<p>There are two main reasons why slicing can be slow.</p>
<ol class="arabic simple">
<li><p>Some layer specific slicing operations perform non-trivial calculations (e.g. points).</p></li>
<li><p>The layer data is read lazily (i.e. it is not in RAM) and latency from the source may be non-negligible (e.g. stored remotely, napari-omero plugin).</p></li>
</ol>
<p>By slicing asynchronously, we can keep napari responsive while allowing for slow
slicing operations. We could also consider optimizing napari to make (1) less of
a problem, but that is outside the scope of this project.</p>
<p>Introducing asynchrony to software often complicates program flow and logic.
However, the existing technical design of slicing is already complicated and
often causes issues for developers.</p>
<ul class="simple">
<li><p>Layers have too much state <a class="footnote-reference brackets" href="#issue-792" id="id1">1</a> <a class="footnote-reference brackets" href="#issue-1353" id="id2">2</a> <a class="footnote-reference brackets" href="#issue-1775" id="id3">3</a>.</p></li>
<li><p>The logic is hard to understand and debug <a class="footnote-reference brackets" href="#issue-2156" id="id4">4</a>.</p></li>
<li><p>The names of the classes are not self-explanatory <a class="footnote-reference brackets" href="#issue-1574" id="id5">5</a>.</p></li>
</ul>
<p>Some of these issues were caused by a previous effort around asynchronous slicing
in an effort to keep it isolated from the core code base.
By contrast, our approach in this project is to redesign slicing in napari to
provide a solid foundation for asychronous slicing and related future work like
multi-canvas and multi-scale slicing.</p>
<section id="goals">
<h3>Goals<a class="headerlink" href="#goals" title="Permalink to this headline">¶</a></h3>
<p>To summarize the scope of this project, we define a few high level goals.
Each goal has many prioritized features where P0 is a must-have, P1 is a should-have,
and P2 is a could-have. Some of these goals may already be achieved by napari in its
current form, but are captured here to prevent any regression caused by this work.</p>
<section id="keep-responding-when-slicing-slow-data">
<h4>1. Keep responding when slicing slow data<a class="headerlink" href="#keep-responding-when-slicing-slow-data" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>P0. When moving a dimension slider, the slider can still be controlled so that I can navigate to the desired location.</p>
<ul>
<li><p>Slider can be moved when data is in the middle of loading.</p></li>
<li><p>Slider location does not return to position of last loaded slice after it was moved to a different position.</p></li>
</ul>
</li>
<li><p>P0. When the slider is dragged, only slice at some positions so that I don’t wait for unwanted intermediate slicing positions.</p>
<ul>
<li><p>Once slider is moved, wait before performing slicing operation, and cancel any prior pending slices (i.e. be lazy).</p></li>
<li><p>If we can reliably infer that slicing will be fast (e.g. data is a numpy array), consider skipping this delay.</p></li>
</ul>
</li>
<li><p>P0. When slicing fails, I am notified so that I can understand what went wrong.</p>
<ul>
<li><p>May want to limit the number of notifications (e.g. lost network connection for remote data).</p></li>
</ul>
</li>
<li><p>P1. When moving a dimension slider and the slice doesn’t immediately load, I am notified that it is being generated, so that I am aware that my action is being handled.</p>
<ul>
<li><p>Need a visual cue that a slice is loading.</p></li>
<li><p>Show visual cue to identify the specific layer(s) that are loading in the case where one layer loads faster than another.</p></li>
</ul>
</li>
</ul>
</section>
<section id="clean-up-slice-state-and-logic-in-layers">
<h4>2. Clean up slice state and logic in layers<a class="headerlink" href="#clean-up-slice-state-and-logic-in-layers" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>P0. Encapsulate the slice input and output state for each layer type, so that I can quickly and clearly identify those.</p>
<ul>
<li><p>Minimize number of (nested) classes per layer-type (e.g. <code class="docutils literal notranslate"><span class="pre">ImageSlice</span></code>, <code class="docutils literal notranslate"><span class="pre">ImageSliceData</span></code>, <code class="docutils literal notranslate"><span class="pre">ImageView</span></code>, <code class="docutils literal notranslate"><span class="pre">ImageLoader</span></code>).</p></li>
</ul>
</li>
<li><p>P0. Simplify the program flow of slicing, so that developing and debugging against allows for faster implementation.</p>
<ul>
<li><p>Reduce the complexity of the call stack associated with slicing a layer.</p></li>
<li><p>The implementation details for some layer/data types might be complex (e.g. multi-scale image), but the high level logic should be simple.</p></li>
</ul>
</li>
<li><p>P1. Move the slice state off the layer, so that its attributes only represent the whole data.</p>
<ul>
<li><p>Layer may still have a function to get a slice.</p></li>
<li><p>May need alternatives to access currently private state, though doesn’t necessarily need to be in the Layer (e.g. a plugin with an ND layer, that gets interaction data from 3D visualization , needs some way to get that data back to ND).</p></li>
</ul>
</li>
<li><p>P2. Store multiple slices associated with each layer, so that I can cache previously generated slices.</p>
<ul>
<li><p>Pick a default cache size that should not strain most machines (e.g. 0-1GB).</p></li>
<li><p>Make cache size a user defined preference.</p></li>
</ul>
</li>
</ul>
</section>
<section id="measure-slicing-latencies-on-representative-examples">
<h4>3. Measure slicing latencies on representative examples<a class="headerlink" href="#measure-slicing-latencies-on-representative-examples" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>P0. Define representative examples that currently cause <em>desirable</em> behavior in napari, so that I can check that async slicing does not degrade those.</p>
<ul>
<li><p>E.g. 2D slice of a 3D image layer where all data fits in RAM, but not VRAM.</p></li>
</ul>
</li>
<li><p>P0. Define representative examples that currently cause <em>undesirable</em> behavior in napari, so that I can check that async slicing improves those.</p>
<ul>
<li><p>E.g. 2D slice of a 3D points layer where all data fits in RAM, but not VRAM.</p></li>
<li><p>E.g. 2D slice of a 3D image layer where all data is not on local storage.</p></li>
</ul>
</li>
<li><p>P0. Define slicing benchmarks, so that I can understand if my changes impact overall timing or memory usage.</p>
<ul>
<li><p>E.g. Do not increase the latency of generating a single slice more than 10%.</p></li>
<li><p>E.g. Decrease the latency of dealing with 25 slice requests over 1 second by 50%.</p></li>
</ul>
</li>
<li><p>P1. Log specific slicing latencies, so that I can summarize important measurements beyond granular profile timings.</p>
<ul>
<li><p>Latency logs are local only (i.e. not sent/stored remotely).</p></li>
<li><p>Add an easy way for users to enable writing these latency measurements.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="non-goals">
<h3>Non-goals<a class="headerlink" href="#non-goals" title="Permalink to this headline">¶</a></h3>
<p>To help clarify the scope, we also define some things that were are not explicit goals of this project and briefly explain why they were omitted.</p>
<ul class="simple">
<li><p>Make a single slicing operation faster.</p>
<ul>
<li><p>Useful, but can be done independently of this work.</p></li>
</ul>
</li>
<li><p>Improve slicing functionality.</p>
<ul>
<li><p>Useful, but can be done independently of this work.</p></li>
</ul>
</li>
<li><p>Make async a toggleable setting (i.e. async is always on).</p>
<ul>
<li><p>May complicate the program flow of slicing.</p></li>
<li><p>May still automatically infer that slicing can be synchronously.</p></li>
</ul>
</li>
<li><p>When a slice doesn’t immediately load, show a low level of detail version of it, so that I can preview what is upcoming.</p>
<ul>
<li><p>Requires a low level of detail version to exist.</p></li>
<li><p>Should be part of a to-be-defined multi-scale project.</p></li>
</ul>
</li>
<li><p>Store multiple slices associated with each layer, so that I can easily implement a multi-canvas mode for napari.</p>
<ul>
<li><p>Should be part of a to-be-defined multi-canvas project.</p></li>
<li><p>Solutions for goal (2) should not block this in the future.</p></li>
</ul>
</li>
<li><p>Open, save, or process layers asynchronously.</p>
<ul>
<li><p>More related to plugin execution.</p></li>
</ul>
</li>
<li><p>Lazily load parts of data based on the canvas’ current field of view.</p>
<ul>
<li><p>An optimization that is dependent on specific data formats.</p></li>
</ul>
</li>
<li><p>Identify and assign dimensions to layers and transforms.</p>
<ul>
<li><p>Should be part of a to-be-defined dimensions project.</p></li>
<li><p>Solutions for goal (2) should not block this in the future.</p></li>
</ul>
</li>
<li><p>Thick slices of non-visualized dimensions.</p>
<ul>
<li><p>Currently being prototyped in <a class="footnote-reference brackets" href="#pull-4334" id="id6">6</a>.</p></li>
<li><p>Solutions for goal (2) should not block this in the future.</p></li>
</ul>
</li>
<li><p>Keep the experimental async fork working.</p>
<ul>
<li><p>Nice to have, but should not put too much effort into this.</p></li>
<li><p>May want to remove it to avoid confusion.</p></li>
</ul>
</li>
</ul>
</section>
</section>
<section id="related-work">
<h2>Related work<a class="headerlink" href="#related-work" title="Permalink to this headline">¶</a></h2>
<p>As this project focuses on re-designing slicing in napari, this section contains information on how slicing in napari currently works.</p>
<section id="existing-slice-logic">
<h3>Existing slice logic<a class="headerlink" href="#existing-slice-logic" title="Permalink to this headline">¶</a></h3>
<p>The following diagram shows the simplified call sequence generated by moving the position of a dimension slider in napari.</p>
<p><img alt="" src="https://raw.githubusercontent.com/andy-sweet/napari-diagrams/main/napari-slicing-sync-calls.drawio.svg" /></p>
<p>Moving the slider generates mouse events that the Qt main event loop handles,
which eventually emits napari’s <code class="docutils literal notranslate"><span class="pre">Dims.events.current_step</span></code> event, which in turn
triggers the refresh of each layer. A refresh first updates the layer’s slice state
using <code class="docutils literal notranslate"><span class="pre">Layer.set_view_slice</span></code>, then emits the <code class="docutils literal notranslate"><span class="pre">Layer.events.set_data</span></code> event,
which finally passes on the layer’s new slice state to the vispy scene node
using <code class="docutils literal notranslate"><span class="pre">VispyBaseLayer._on_data_change</span></code>.</p>
<p>All these calls occur on the main thread so the app does not return to the Qt main event
loop until each layer has been sliced and each vispy node has been updated. This means that
any other updates to the app, like redrawing the slider position, or other user interactions
with the app, like moving the slider somewhere else, are blocked until slicing is done.
This is what causes napari to stop responding when slicing is slow.</p>
<p>Each subclass of <code class="docutils literal notranslate"><span class="pre">Layer</span></code> has its own type-specific implementation of <code class="docutils literal notranslate"><span class="pre">set_view_slice</span></code>,
which uses the updated dims state in combination with <code class="docutils literal notranslate"><span class="pre">Layer.data</span></code> to generate and store sliced data.
Similarly, each subclass of <code class="docutils literal notranslate"><span class="pre">VispyBaseLayer</span></code> has its own type-specific implementation of <code class="docutils literal notranslate"><span class="pre">_on_data_change</span></code>,
which gets the new sliced data in the layer, may post-process it, and finally passes it to vispy to be rendered on the GPU.</p>
</section>
<section id="existing-slice-state">
<h3>Existing slice state<a class="headerlink" href="#existing-slice-state" title="Permalink to this headline">¶</a></h3>
<p>It’s important to understand what state is currently used by and generated by slicing because
solutions for this project may cause this state to be read and write from multiple threads.
Rather than exhaustively list all of the slice state of all layer types and their dependencies <a class="footnote-reference brackets" href="#slice-class-diagram" id="id7">7</a>,
we group and highlight some of the more important state.</p>
<section id="input-state">
<h4>Input state<a class="headerlink" href="#input-state" title="Permalink to this headline">¶</a></h4>
<p>Some input state for slicing is directly mutated by <code class="docutils literal notranslate"><span class="pre">Layer._slice_dims</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">_ndisplay:</span> <span class="pre">int</span></code>, the display dimensionality (either 2 or 3).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_dims_point:</span> <span class="pre">List[Union[numeric,</span> <span class="pre">slice]]</span></code>, the current slice position in world coordinates.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_dims_order:</span> <span class="pre">Tuple[int,</span> <span class="pre">...]</span></code>, the ordering of dimensions, where the last few are visualized in the canvas.</p></li>
</ul>
<p>Note that while <code class="docutils literal notranslate"><span class="pre">Layer._update_dims</span></code> can mutate more state, it should only do so when
the dimensionality of the layer has changed, which should not happen when only interacting with existing data.</p>
<p>Other input state comes from more permanent and public properties of <code class="docutils literal notranslate"><span class="pre">Layer</span></code>, which are critical to the slicing operation.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">data:</span> <span class="pre">ArrayLike</span></code>, the full data to be sliced.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_transforms:</span> <span class="pre">TransformChain</span></code>, transforms sliced data coordinates to vispy-world coordinates.</p></li>
</ul>
<p>Finally, there are some layer-type specific properties that are used to customize the visualized slice.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">_ImageBase</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">rgb:</span> <span class="pre">bool</span></code> True if the leading dimension contains RGB(A) channels that should be visualized as such.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">Points</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">face_color,</span> <span class="pre">edge_color:</span> <span class="pre">Array[float,</span> <span class="pre">(N,</span> <span class="pre">4)]</span></code>, the face and edge colors of each point.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">size:</span> <span class="pre">Array[float,</span> <span class="pre">(N,</span> <span class="pre">D)]</span></code>, the size of each point.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">edge_width:</span> <span class="pre">Array[float,</span> <span class="pre">(N,)]</span></code>, the width of each point’s edge.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">shown:</span> <span class="pre">Array[bool,</span> <span class="pre">(N,)]</span></code>, the visibility of each point.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">out_of_slice_display:</span> <span class="pre">bool</span></code>, if True some points may be included in more than one slice based on their size.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">Shapes</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">face_color,</span> <span class="pre">edge_color:</span> <span class="pre">Array[float,</span> <span class="pre">(N,</span> <span class="pre">4)]</span></code>, the face and edge colors of each shape.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">edge_width:</span> <span class="pre">Array[float,</span> <span class="pre">(N,)]</span></code>, the width of shape’s edges.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_data_view:</span> <span class="pre">ShapeList</span></code>, stores all shapes’ data.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">_mesh:</span> <span class="pre">Mesh</span></code>, stores concatenated meshes of all shapes.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">vertices:</span> <span class="pre">Array[float,</span> <span class="pre">(Q,</span> <span class="pre">D)]</span></code>, the vertices of all shapes.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">Vectors</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">edge_color:</span> <span class="pre">Array[float,</span> <span class="pre">(N,)]</span></code>, the color of each vector.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">edge_width:</span> <span class="pre">Array[float,</span> <span class="pre">(N,)]</span></code>, the width of each vector.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">length:</span> <span class="pre">numeric</span></code>, multiplicative length scaling all vectors.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">out_of_slice_display:</span> <span class="pre">bool</span></code>, if True some vectors may be included in more than one slice based on their length.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_mesh_vertices</span></code>, output from <code class="docutils literal notranslate"><span class="pre">generate_vector_meshes</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_mesh_triangles</span></code>, output from <code class="docutils literal notranslate"><span class="pre">generate_vector_meshes</span></code>.</p></li>
</ul>
</li>
</ul>
<p>Many of these are just indexed as part of slicing.
For example, <code class="docutils literal notranslate"><span class="pre">Points.face_color</span></code> is indexed by the points that are visible in the current slice.</p>
</section>
<section id="output-state">
<h4>Output state<a class="headerlink" href="#output-state" title="Permalink to this headline">¶</a></h4>
<p>The output of slicing is typically layer-type specific, stored as state
on the layer, and mostly consumed by the corresponding vispy layer.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">_ImageBase</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">_slice:</span> <span class="pre">ImageSlice</span></code>, contains a loader, and the sliced image and thumbnail</p>
<ul>
<li><p>much complexity encapsulated here and other related classes like <code class="docutils literal notranslate"><span class="pre">ImageSliceData</span></code>.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">Points</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">__indices_view:</span> <span class="pre">Array[int,</span> <span class="pre">(M,)]</span></code>, indices of points (i.e. rows of <code class="docutils literal notranslate"><span class="pre">data</span></code>) that are in the current slice.</p>
<ul>
<li><p>many private properties derived from this (e.g. <code class="docutils literal notranslate"><span class="pre">_indices_view</span></code>, <code class="docutils literal notranslate"><span class="pre">_view_data</span></code>).</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">_view_size_scale:</span> <span class="pre">Union[float,</span> <span class="pre">Array[float,</span> <span class="pre">(M,)]]</span></code>, used with thick slices of points <code class="docutils literal notranslate"><span class="pre">_view_size</span></code> to make out of slice points appear smaller.</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">Shapes</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">_data_view:</span> <span class="pre">ShapeList</span></code>, stores all shapes’ data.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">_mesh:</span> <span class="pre">Mesh</span></code>, stores concatenated meshes of all shapes.</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">displayed_triangles:</span> <span class="pre">Array[int,</span> <span class="pre">(M,</span> <span class="pre">3)]</span></code>, triangles to be drawn.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">displayed_triangles_colors:</span> <span class="pre">Array[float,</span> <span class="pre">(M,</span> <span class="pre">4)]</span></code>, per triangle color.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">Vectors</span></code></p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">_view_indices:</span> <span class="pre">Array[int,</span> <span class="pre">(-1)]</span></code>, indices of vectors that are in the current slice.</p>
<ul>
<li><p>lots of private properties derived from this (e.g. <code class="docutils literal notranslate"><span class="pre">_view_face_color</span></code>, <code class="docutils literal notranslate"><span class="pre">_view_faces</span></code>).</p></li>
</ul>
</li>
</ul>
</li>
</ul>
<p>The vispy layers also read other state from their corresponding layer.
In particular they read <code class="docutils literal notranslate"><span class="pre">Layer._transforms</span></code> to produce a transform that can be used to properly
represent the layer in the vispy scene coordinate system.</p>
</section>
</section>
</section>
<section id="detailed-description">
<h2>Detailed description<a class="headerlink" href="#detailed-description" title="Permalink to this headline">¶</a></h2>
<p>The following diagram shows the new proposed approach to slicing layers asynchronously.</p>
<p><img alt="" src="https://raw.githubusercontent.com/andy-sweet/napari-diagrams/main/napari-slicing-async-calls.drawio.svg" /></p>
<p>As with the existing synchronous slicing design, the <code class="docutils literal notranslate"><span class="pre">Dims.events.current_step</span></code> event
is the shared starting point. In the new approach, we pass <code class="docutils literal notranslate"><span class="pre">ViewerModel.layers</span></code> through
to the newly defined <code class="docutils literal notranslate"><span class="pre">LayerSlicer</span></code>, which makes a slice request for each layer on the main thread.
This request is processed asynchronously on a dedicated thread for slicing, while the main thread
returns quickly to the Qt main event loop, allowing napari to keep responding to other updates
and interactions. When all the layers have generated slice responses on the slicing thread,
the <code class="docutils literal notranslate"><span class="pre">slice_ready</span></code> event is emitted. That triggers <code class="docutils literal notranslate"><span class="pre">QtViewer.on_slice_ready</span></code> to be executed on
the main thread, so that the underlying <code class="docutils literal notranslate"><span class="pre">QWidgets</span></code> can be safely updated.</p>
<p>The rest of this section defines some new types to encapsulate state that is critical
to slicing and some new methods that redefine the core logic of slicing.</p>
<section id="request-and-response">
<h3>Request and response<a class="headerlink" href="#request-and-response" title="Permalink to this headline">¶</a></h3>
<p>First, we introduce a request to encapsulate the required input to slicing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LayerSliceRequest</span><span class="p">:</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">ArrayLike</span>
    <span class="n">world_to_data</span><span class="p">:</span> <span class="n">Transform</span>
    <span class="n">point</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">dims_displayed</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">dims_not_displayed</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
</pre></div>
</div>
<p>At a minimum, this request must contain the data to be sliced, the point at
which we are slicing in napari’s shared world coordinate system, and a way to
transform world coordinates to a layer’s data coordinate system.
In the future, the point may become a bounding box that includes the current
field of view.
Given our understanding about the existing slice input state, each layer type
should extend this request type to capture the input it needs for slicing, such
as <code class="docutils literal notranslate"><span class="pre">Points.face_color</span></code>.</p>
<p>Second, we introduce a response to encapsulate the output of slicing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">LayerSliceResponse</span><span class="p">:</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">ArrayLike</span>
    <span class="n">data_to_world</span><span class="p">:</span> <span class="n">Transform</span>
</pre></div>
</div>
<p>At a minimum, this response must contain the sliced data and a transform that
tells us where that data lives in the currently displayed scene of napari’s
shared world coordinate system.
At this point <code class="docutils literal notranslate"><span class="pre">data</span></code> should be fast to access either from RAM (e.g. as a numpy
array) or VRAM (e.g. as a CuPy array), so that it can be consumed on the main
thread without blocking other operations for long.</p>
<p>For each layer type, we need to extend the request and response types to include
state that is specific to slicing those types of layers. For example, the image
request type should look something like the following.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ImageSliceRequest</span><span class="p">(</span><span class="n">LayerSliceRequest</span><span class="p">):</span>
    <span class="n">rgb</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">multiscale</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">corner_pixels</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">data_level</span><span class="p">:</span> <span class="nb">int</span>

<span class="k">class</span> <span class="nc">ImageSliceResponse</span><span class="p">(</span><span class="n">LayerSliceResponse</span><span class="p">)</span>
    <span class="n">thumbnail</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
</pre></div>
</div>
<p>As napari supports RGB and multi-scale images, we need a few more inputs to
know what data should be accessed to generate the desired slice for the canvas.
And the thumbnail needs to access the layer data as well, so should do so while
we are slicing asynchronous to avoid any blocking behavior.</p>
<p>The points request and response types should look something like the following.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">PointsSliceRequest</span><span class="p">(</span><span class="n">LayerSliceRequest</span><span class="p">):</span>
    <span class="n">out_of_slice_display</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">size</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">shown</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">face_color</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">edge_color</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">edge_width</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>

<span class="k">class</span> <span class="nc">PointsSliceResponse</span><span class="p">(</span><span class="n">LayerSliceResponse</span><span class="p">):</span>
    <span class="n">indices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">size</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">view_size_scale</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span>
    <span class="n">face_color</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">edge_color</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
    <span class="n">edge_width</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span>
</pre></div>
</div>
<p>While the names and typing of some of the points request and response attributes
are the same (e.g. <code class="docutils literal notranslate"><span class="pre">face_color</span></code>) they differ semantically because the response
represent the sliced values only. Defining two distinct and explicit request and
response types gives us more flexibility later in terms of how slicing works.
For example, we may want to generate point face colors lazily, which could mean
that <code class="docutils literal notranslate"><span class="pre">PointsSliceRequest.face_color</span></code> would become a callable instead of a
materialized array as in the response.</p>
</section>
<section id="layer-methods">
<h3>Layer methods<a class="headerlink" href="#layer-methods" title="Permalink to this headline">¶</a></h3>
<p>We require that each Layer type implements two methods related to slicing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Layer</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_make_slice_request</span><span class="p">(</span><span class="n">dims</span><span class="p">:</span> <span class="n">Dims</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LayerSliceRequest</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>

    <span class="nd">@abstractmethod</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_slice</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">LayerSliceRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">LayerSliceResponse</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
<p>The first, <code class="docutils literal notranslate"><span class="pre">_make_slice_request</span></code>, combines the state of the layer with the
current state of the viewer’s instance of <code class="docutils literal notranslate"><span class="pre">Dims</span></code> passed in as a parameter
to create an immutable slice request that the slicing operation will use
on another thread.
This method should be called from the main thread, so that nothing else
should be mutating the <code class="docutils literal notranslate"><span class="pre">Layer</span></code> or <code class="docutils literal notranslate"><span class="pre">Dims</span></code>.
Therefore, we should try to ensure that this method returns quickly, so as
not to block the main thread.</p>
<p>Most of the request’s fields, like <code class="docutils literal notranslate"><span class="pre">point</span></code> and <code class="docutils literal notranslate"><span class="pre">dims_displayed</span></code> are small,
and can be quickly copied in this new instance.
Other fields, like <code class="docutils literal notranslate"><span class="pre">data</span></code>, are too large to copy in general, so instead we
store a reference.
If that reference is mutated in-place on the main thread while slicing is being
performed on another thread, this may create an inconsistent slice output
depending on when the values in <code class="docutils literal notranslate"><span class="pre">data</span></code> are accessed, but should be safe because
the <code class="docutils literal notranslate"><span class="pre">shape</span></code> and <code class="docutils literal notranslate"><span class="pre">dtype</span></code> cannot change.
If <code class="docutils literal notranslate"><span class="pre">Layer.data</span></code> is reassigned on the main thread, then we can safely slice
using the reference to the old data, though we may not want to consume
the now stale output.</p>
<p>The second, <code class="docutils literal notranslate"><span class="pre">_get_slice</span></code>, takes the slice request and generates a response
using layer-type specific logic.
The method is static to prevent it from using any layer state directly and
instead can only use the state in the immutable slice request.
This allows us to execute this method on another thread without worrying
about mutations to the layer that might occur on the main thread.</p>
<p>The main consumer of a layer slice response is the corresponding vispy
layer. We require that a vispy layer type implement <code class="docutils literal notranslate"><span class="pre">_set_slice</span></code> to handle
how it consumes the slice output.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">VispyBaseLayer</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="nd">@abstractmethod</span>
    <span class="k">def</span> <span class="nf">_set_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">LayerSliceResponse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</pre></div>
</div>
</section>
<section id="layer-slicer">
<h3>Layer slicer<a class="headerlink" href="#layer-slicer" title="Permalink to this headline">¶</a></h3>
<p>We define a dedicated class to handle execution of slicing tasks to
avoid the associated state and logic leaking into the already complex
<code class="docutils literal notranslate"><span class="pre">ViewerModel</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ViewerSliceRequest</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Layer</span><span class="p">,</span> <span class="n">LayerSliceRequest</span><span class="p">]</span>
<span class="n">ViewerSliceResponse</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">[</span><span class="n">Layer</span><span class="p">,</span> <span class="n">LayerSliceResponse</span><span class="p">]</span>

<span class="k">class</span> <span class="nc">LayerSlicer</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="n">_executor</span><span class="p">:</span> <span class="n">Executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">_task</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Future</span><span class="p">[</span><span class="n">ViewerSliceResponse</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span> <span class="o">=</span> <span class="n">EmitterGroup</span><span class="p">(</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">slice_ready</span><span class="o">=</span><span class="n">Event</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">slice_layers_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">layers</span><span class="p">:</span> <span class="n">LayerList</span><span class="p">,</span> <span class="n">dims</span><span class="p">:</span> <span class="n">Dims</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Future</span><span class="p">[</span><span class="n">ViewerSliceResponse</span><span class="p">]:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
        <span class="n">requests</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">layer</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">_make_slice_request</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="n">layers</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_slice_layers</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_slice_done</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task</span>

    <span class="k">def</span> <span class="nf">slice_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">requests</span><span class="p">:</span> <span class="n">ViewerSliceRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ViewerSliceResponse</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">layer</span><span class="p">:</span> <span class="n">layer</span><span class="o">.</span><span class="n">_get_slice</span><span class="p">(</span><span class="n">request</span><span class="p">)</span> <span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">request</span> <span class="ow">in</span> <span class="n">requests</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">def</span> <span class="nf">_on_slice_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Future</span><span class="p">[</span><span class="n">ViewerSliceResponse</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">task</span><span class="o">.</span><span class="n">cancelled</span><span class="p">():</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">slice_ready</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>
</pre></div>
</div>
<p>For this class to be useful, there should be at least one connection to the <code class="docutils literal notranslate"><span class="pre">slice_ready</span></code> event.
In napari, we expect the <code class="docutils literal notranslate"><span class="pre">QtViewer</span></code> to marshall the slice response that this signal carries
to the vispy layers so that the canvas can be updated.</p>
</section>
<section id="hooking-up-the-viewer">
<h3>Hooking up the viewer<a class="headerlink" href="#hooking-up-the-viewer" title="Permalink to this headline">¶</a></h3>
<p>Using Python’s standard library threads in the <code class="docutils literal notranslate"><span class="pre">ViewerModel</span></code>
means that we have a portable way to perform asynchronous slicing
in napari without an explicit dependency on Qt.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ViewerModel</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="n">dims</span><span class="p">:</span> <span class="n">Dims</span>
    <span class="n">_slicer</span><span class="p">:</span> <span class="n">LayerSlicer</span> <span class="o">=</span> <span class="n">LayerSlicer</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">current_step</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_slice_layers_async</span><span class="p">)</span>

    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">_slice_layers_async</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_slicer</span><span class="o">.</span><span class="n">slice_layers_async</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layers</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>
</pre></div>
</div>
<p>Initially we intend for each instance of <code class="docutils literal notranslate"><span class="pre">ViewerModel</span></code> to own a single
instance of a <code class="docutils literal notranslate"><span class="pre">LayerSlicer</span></code> for the lifetime of that <code class="docutils literal notranslate"><span class="pre">ViewerModel</span></code> instance.
That allows the <code class="docutils literal notranslate"><span class="pre">LayerSlicer</span></code> to coordinate slicing of any or all layers
for a particular viewer instance, while allowing multiple viewer instances
to slice independently.</p>
<p>The main response to the slice being ready occurs on the <code class="docutils literal notranslate"><span class="pre">QtViewer</span></code>
because <code class="docutils literal notranslate"><span class="pre">QtViewer.layer_to_visual</span></code> provides a way to map from
a layer to its corresponding vispy layer.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">QtViewer</span><span class="p">:</span>
    <span class="o">...</span>

    <span class="n">viewer</span><span class="p">:</span> <span class="n">ViewerModel</span>
    <span class="n">layer_to_visual</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Layer</span><span class="p">,</span> <span class="n">VispyBaseLayer</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">_slicer</span><span class="o">.</span><span class="n">events</span><span class="o">.</span><span class="n">slice_ready</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_slice_ready</span><span class="p">)</span>

    <span class="nd">@ensure_main_thread</span>
    <span class="k">def</span> <span class="nf">_on_slice_ready</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">responses</span><span class="p">:</span> <span class="n">ViewerSliceResponse</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">layer</span><span class="p">,</span> <span class="n">response</span> <span class="ow">in</span> <span class="n">responses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">visual</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer_to_visual</span><span class="p">[</span><span class="n">layer</span><span class="p">]:</span>
                <span class="n">visual</span><span class="o">.</span><span class="n">_set_slice</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
</pre></div>
</div>
<p>The other reason is because <code class="docutils literal notranslate"><span class="pre">QtViewer</span></code> is a <code class="docutils literal notranslate"><span class="pre">QObject</span></code> that lives in the main
thread, which makes it easier to ensure that the slice response is handled
on the main thread.
That’s useful because Qt widgets and vispy nodes can only be safely updated
on the main thread <a class="footnote-reference brackets" href="#vispy-faq-threads" id="id8">8</a>, both of which occur when consuming
slice output.</p>
</section>
</section>
<section id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p>A tracking issue <a class="footnote-reference brackets" href="#tracking-issue" id="id9">9</a> serves as a way to communicate high level
progress and discussion.</p>
<p>A prototype <a class="footnote-reference brackets" href="#prototype-pr" id="id10">10</a> has been created that implements the approach described
above to show its basic technical feasibility in napari’s existing code base.
It only implements it for some layer types, some slicing operations, and may
not work when layer data is mutated.
There are some other rough edges and plenty of ways to break it, but basic
functionality should work.</p>
<p>The rough implementation plan is as follows.</p>
<ul class="simple">
<li><p>Implement pure refactors related to slicing to support this work (no public API or behavior changes).</p></li>
<li><p>Implement high-level asynchronous slicing model described here (i.e. add <code class="docutils literal notranslate"><span class="pre">LayerSlicer</span></code>, changes to <code class="docutils literal notranslate"><span class="pre">ViewerModel</span></code>), but with existing layer slicing implementation (i.e. <code class="docutils literal notranslate"><span class="pre">Layer._set_view_slice</span></code>).</p></li>
<li><p>Incrementally add layer slicing implementation described here (i.e. <code class="docutils literal notranslate"><span class="pre">Layer._get_slice</span></code>) for each layer separately.</p></li>
</ul>
<p>This allows us to merge small pieces of work into <code class="docutils literal notranslate"><span class="pre">main</span></code>, testing and fixing
them as we go. The alternative is to maintain a large branch/fork of napari that
may be less tested and harder to merge in the end.</p>
</section>
<section id="backward-compatibility">
<h2>Backward compatibility<a class="headerlink" href="#backward-compatibility" title="Permalink to this headline">¶</a></h2>
<section id="breaks-synchronous-slicing-behavior">
<h3>Breaks synchronous slicing behavior<a class="headerlink" href="#breaks-synchronous-slicing-behavior" title="Permalink to this headline">¶</a></h3>
<p>The main goal of this project is to perform slicing asynchronously, so it’s
natural that we might break anyone that was depending on slicing being synchronous.
In particular, users or plugins that rely on <code class="docutils literal notranslate"><span class="pre">Viewer.screenshot</span></code> to capture the
contents of the canvas after updating things like <code class="docutils literal notranslate"><span class="pre">Dims.current_step</span></code> will be affected.</p>
<p>Our proposal will break that usage in general, but we plan to offer some public way to
force synchronous slicing. For example, one promising idea is to define a context manager
that would temporarily force <code class="docutils literal notranslate"><span class="pre">LayerSlicer</span></code> to always wait for asynchronous tasks to finish
and could be used as follows.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">viewer</span><span class="o">.</span><span class="n">sync_slicing</span><span class="p">():</span>
    <span class="n">viewer</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">current_step</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">viewer</span><span class="o">.</span><span class="n">screenshot</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>Having such a mechanism in <code class="docutils literal notranslate"><span class="pre">LayerSlicer</span></code> also allows us to implement support for
async slicing incrementally for each layer type.</p>
</section>
<section id="store-existing-slice-state-on-layer">
<h3>Store existing slice state on layer<a class="headerlink" href="#store-existing-slice-state-on-layer" title="Permalink to this headline">¶</a></h3>
<p>Many existing napari behaviors depend on the existing slice input and output state
on the layer instances. In this proposal, we decide not to remove this state from the
layer yet to prevent breaking other functionality that relies on it. As slice output is
now generated asynchronously, we must ensure that this state is read and written atomically
to mutually exclude the main and slicing thread from reading and writing inconsistent
parts of that state.</p>
<p>In order to do this, we plan to encapsulate the input and output state of each state into
private dataclasses. There are no API changes, but this forces any read/write access of
this state to acquire an associated lock.</p>
</section>
</section>
<section id="future-work">
<h2>Future work<a class="headerlink" href="#future-work" title="Permalink to this headline">¶</a></h2>
<section id="render-each-slice-as-soon-as-it-is-ready">
<h3>Render each slice as soon as it is ready<a class="headerlink" href="#render-each-slice-as-soon-as-it-is-ready" title="Permalink to this headline">¶</a></h3>
<p>In this proposal, the slicing thread waits for slices of all layers to be ready before
it emits the <code class="docutils literal notranslate"><span class="pre">slice_ready</span></code> event. There are a few reasons for that.</p>
<ol class="arabic simple">
<li><p>We only use one slicing thread to keep behavior simple and to avoid GIL contention.</p></li>
<li><p>It’s closer to the existing behavior of napari</p></li>
<li><p>Shouldn’t introduce any new potential bugs, such as <a class="footnote-reference brackets" href="#issue-2862" id="id11">11</a>.</p></li>
<li><p>It needs less UX design work to decide what should be shown while we are waiting for slices to be ready.</p></li>
</ol>
<p>In some cases, rendering slices as soon as possible will provide a better user experience,
especially when some layers are substantially slower than others. Therefore, this should be
high priority future work.</p>
<p>To implement this behavior as a small extension to this proposal, we could do something like the following.</p>
<ul class="simple">
<li><p>Use multiple workers in the <code class="docutils literal notranslate"><span class="pre">LayerSlicer._executor</span></code>.</p></li>
<li><p>Submit each call to <code class="docutils literal notranslate"><span class="pre">Layer._get_slice</span></code> separately.</p></li>
<li><p>When each call is done, emit a separate <code class="docutils literal notranslate"><span class="pre">slice_ready</span></code> event that only contains each layer’s slice response,
so that the viewer/vispy can update as soon as possible.</p></li>
</ul>
<p>This would cause a <a class="reference external" href="https://raw.githubusercontent.com/andy-sweet/napari-diagrams/main/napari-slicing-async-calls-asap.drawio.svg">more complex call sequence</a>
and could make cancellation behavior more complex, but may be worth it regardless.</p>
</section>
</section>
<section id="alternatives">
<h2>Alternatives<a class="headerlink" href="#alternatives" title="Permalink to this headline">¶</a></h2>
<section id="extend-the-existing-experimental-async-code">
<h3>Extend the existing experimental async code<a class="headerlink" href="#extend-the-existing-experimental-async-code" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Already being used somewhat successfully by some napari users in the wild.</p></li>
<li><p>Can still reuse some of the code, tooling, and learnings from this project.</p></li>
<li><p>The technical design of this approach was not well received (i.e. there is a reason it is experimental).</p></li>
<li><p>Does not address goal 2.</p></li>
</ul>
</section>
<section id="just-call-set-view-slice-or-refresh-asynchronously">
<h3>Just call <code class="docutils literal notranslate"><span class="pre">set_view_slice</span></code> or <code class="docutils literal notranslate"><span class="pre">refresh</span></code> asynchronously<a class="headerlink" href="#just-call-set-view-slice-or-refresh-asynchronously" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Simple to implement with few code changes needed.</p></li>
<li><p>Needs at least one lock to provide sensible access to layer slice state.</p></li>
<li><p>This will need to be acquired to access this state and at the beginning of many methods that access any of that state.</p></li>
<li><p>How to emit events on the main thread?</p></li>
<li><p>Does not address goal 2.</p></li>
</ul>
</section>
<section id="just-access-data-asynchronously">
<h3>Just access <code class="docutils literal notranslate"><span class="pre">data</span></code> asynchronously<a class="headerlink" href="#just-access-data-asynchronously" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Targets main cause of unresponsiveness (i.e. reading data).</p></li>
<li><p>No events are emitted on the non-main thread.</p></li>
<li><p>Less lazy when cancelling is possible (i.e. we do more work on the main thread before submitting the async task).</p></li>
<li><p>Splits up slicing logic into pre/post data reading, making program flow harder to follow.</p></li>
<li><p>Does not address goal 2.</p></li>
</ul>
</section>
<section id="use-qthread-and-similar-utilities-instead-of-concurrent-futures">
<h3>Use <code class="docutils literal notranslate"><span class="pre">QThread</span></code> and similar utilities instead of <code class="docutils literal notranslate"><span class="pre">concurrent.futures</span></code><a class="headerlink" href="#use-qthread-and-similar-utilities-instead-of-concurrent-futures" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>Standard way for plugins to support long running operations.</p></li>
<li><p>Can track progress and allow more opportunity for cancellation with <code class="docutils literal notranslate"><span class="pre">yielded</span></code> signal.</p></li>
<li><p>Can easily process done callback (which might update Qt widgets) on main thread.</p></li>
<li><p>Need to define our own task queue to achieve lazy slicing.</p></li>
<li><p>Need to connect a <code class="docutils literal notranslate"><span class="pre">QObject</span></code>, which ties our core to Qt, unless the code that controls threads does not live in core.</p></li>
</ul>
</section>
<section id="use-asyncio-package-instead-of-concurrent-futures">
<h3>Use <code class="docutils literal notranslate"><span class="pre">asyncio</span></code> package instead of <code class="docutils literal notranslate"><span class="pre">concurrent.futures</span></code><a class="headerlink" href="#use-asyncio-package-instead-of-concurrent-futures" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><p>May improve general readability of async code for some.</p></li>
<li><p>Mostly syntactic sugar on top of <code class="docutils literal notranslate"><span class="pre">concurrent.futures</span></code>.</p></li>
<li><p>Likely need an <code class="docutils literal notranslate"><span class="pre">asyncio</span></code> event loop distinct from Qt’s main event loop, which could be confusing and cause issues.</p></li>
<li><p><a class="reference external" href="https://napari.zulipchat.com/#narrow/stream/212875-general/topic/qt-async-threads">As discussed on Zulip</a>, <code class="docutils literal notranslate"><span class="pre">qt-async-threads</span></code> is a possible solution,
but it is still quite new.</p></li>
</ul>
</section>
<section id="slice-from-vispy-layer-instead-of-viewer-model">
<h3>Slice from vispy layer instead of viewer model<a class="headerlink" href="#slice-from-vispy-layer-instead-of-viewer-model" title="Permalink to this headline">¶</a></h3>
<p>Instead of making the <code class="docutils literal notranslate"><span class="pre">ViewerModel</span></code> the driver of slicing, we could instead drive it from the vispy layers.
A rough implementation of this approach could look like the following.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>
<span class="k">class</span> <span class="nc">QtViewer</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">dims</span><span class="o">.</span><span class="n">current_step</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">slice_layers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">slice_layers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">layer</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">layers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">layer_to_visual</span><span class="p">[</span><span class="n">layer</span><span class="p">]</span><span class="o">.</span><span class="n">_slice</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">viewer</span><span class="o">.</span><span class="n">dims</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">Image</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">_make_slice_request</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dims</span><span class="p">:</span> <span class="n">Dims</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ImageSliceRequest</span><span class="p">:</span>
        <span class="o">...</span>
    <span class="k">def</span> <span class="nf">_get_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">ImageSliceRequest</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ImageSliceResponse</span><span class="p">:</span>
        <span class="o">...</span>

<span class="k">class</span> <span class="nc">VispyImageLayer</span><span class="p">:</span>
    <span class="o">...</span>
    <span class="k">def</span> <span class="nf">_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dims</span><span class="p">:</span> <span class="n">Dims</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">_make_slice_request</span><span class="p">(</span><span class="n">dims</span><span class="p">)</span>
        <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">slice_executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">layer</span><span class="o">.</span><span class="n">_get_slice</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span>
        <span class="n">task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_on_slice_done</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_on_slice_done</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">:</span> <span class="n">Future</span><span class="p">[</span><span class="n">ImageSliceResponse</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_slice</span><span class="p">(</span><span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">())</span>

    <span class="nd">@ensure_main_thread</span>
    <span class="k">def</span> <span class="nf">_set_slice</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">ImageSliceResponse</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="o">...</span>
</pre></div>
</div>
<p>Most of the internal guts of slicing, such as the implementation of <code class="docutils literal notranslate"><span class="pre">_get_slice</span></code> and
<code class="docutils literal notranslate"><span class="pre">_make_slice_request</span></code>, are unchanged from the approach proposed here.</p>
<p>The main advantage of this approach is that the main consumer of the slice response (i.e. vispy)
is the one driving slicing, which allows us to better define input and output types and
avoid unnecessary type inheritance.</p>
<p>In the example code above, we avoid a tight dependency on <code class="docutils literal notranslate"><span class="pre">Qt</span></code> using <code class="docutils literal notranslate"><span class="pre">&#64;ensure_main_thread</span></code>.
But another advantage of this general approach is that we could rely on tighter dependencies
between vispy and Qt, which may simplify the implementation and offer some performance benefits.</p>
<p>One disadvantage is that it becomes harder to control the execution of multiple layers being sliced.
For example, with the above implementation we can no longer wait for all layers to be sliced before
updating all the vispy layers.
Another disadvantage is that this implies that slice state should not live in the model in the future,
which might cause issues with things like selection that may depend on that state.</p>
</section>
</section>
<section id="discussion">
<h2>Discussion<a class="headerlink" href="#discussion" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://napari.zulipchat.com/#narrow/stream/296574-working-group-architecture/topic/Async.20slicing.20project">Initial announcement on Zulip</a>.</p>
<ul>
<li><p>Consider (re)sampling instead of slicing as the name for the operation discussed here.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://forum.image.sc/t/even-with-napari-async-1-data-loading-is-blocking-the-ui-thread/68097/4">Problems with <code class="docutils literal notranslate"><span class="pre">NAPARI_ASYNC=1</span></code></a></p>
<ul>
<li><p>The existing experimental async code doesn’t handle some seemingly simple usage.</p></li>
</ul>
</li>
<li><p><a class="reference external" href="https://github.com/napari/napari/issues/4682">Remove slice state from layer</a></p>
<ul>
<li><p>Feature request to remove slice/render state from the layer types.</p></li>
<li><p>Motivated by creating multiple slices of the same layers for multiple canvases.</p></li>
<li><p>Decision: postpone.</p>
<ul>
<li><p>There are too many behaviors that depend on slice state (e.g. <code class="docutils literal notranslate"><span class="pre">Layer._get_value</span></code>) and it’s easy enough to set it after an async slicing task is done, so leave it for now.</p></li>
<li><p>This work should simplify removing it in the future.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference external" href="https://github.com/andy-sweet/napari/pull/16">Draft PR on andy-sweet’s fork</a></p>
<ul>
<li><p>Initial feedback before sharing more widely.</p></li>
</ul>
</li>
<li><p>Define a class that encapsulates the slicing bounding box in world coordinates.</p>
<ul>
<li><p><a class="reference external" href="https://github.com/napari/napari/pull/4892/files#r935771292">Define a class that only encapsulates the dims and camera info needed for slicing</a></p></li>
<li><p><a class="reference external" href="https://github.com/napari/napari/pull/4892/files#r935877117">Replace <code class="docutils literal notranslate"><span class="pre">point</span></code> and similar with <code class="docutils literal notranslate"><span class="pre">bbox</span></code></a></p></li>
<li><p>The idea here is to collapse some of the existing input slicing state like <code class="docutils literal notranslate"><span class="pre">point</span></code> and <code class="docutils literal notranslate"><span class="pre">dims_displayed</span></code> into one class that describes the bounding box for slicing in world coordinates.</p></li>
<li><p>Decision: postpone.</p>
<ul>
<li><p>This can be done independently of this work and the order is not important enough to slow this work down.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference external" href="https://github.com/napari/napari/pull/4892/files#r935773848">Replace layer slice request and response types with a single slice type</a></p>
<ul>
<li><p>Motivation is make it easier to add a new layer type by reducing the number of class types needed.</p></li>
<li><p>Some disagreement here as one type for two purposes (input vs. output) seems confusing.</p></li>
<li><p>Keeping the request and response types separate may also allow us to better target alternatives to vispy.</p></li>
<li><p>Decision: keep request and response types separate for now.</p>
<ul>
<li><p>Adding a new layer type is not a frequent occurrence.</p></li>
<li><p>Having one class may reduce the number of classes, but implementing a new layer type is already quite complex.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference external" href="https://github.com/napari/napari/pull/4892/files#r935322222">Slicing in a shader</a></p>
<ul>
<li><p>How to handle future cases where layer data has been pre-loaded onto the GPU and we want to slice in the shader?</p></li>
<li><p>Less about large/slow data, and more about not blocking approaches to handling small/fast data efficiently.</p></li>
<li><p>May be particularly useful for multi-canvas.</p></li>
<li><p>Decision: postpone.</p>
<ul>
<li><p>Keep related types private or vague to not blocking this in the future.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference external" href="https://github.com/napari/napari/pull/4892/files#r934961214">Support existing usage and plugins that depends on synchronous slicing</a></p>
<ul>
<li><p>Main example is <a class="reference external" href="https://www.napari-hub.org/plugins/napari-animation">the napari-animation plugin</a>, but there may be others.</p></li>
<li><p>This was explored <a class="footnote-reference brackets" href="#pull-4969" id="id12">12</a> with the following main findings.</p>
<ul>
<li><p>Forcing synchronous slicing when combining the prototype and <code class="docutils literal notranslate"><span class="pre">napari-animation</span></code> seems to work for the basic examples.</p></li>
<li><p>We only need to ensure synchronous slicing before using <code class="docutils literal notranslate"><span class="pre">Viewer.screenshot</span></code>, as keyframes just capture the value of <code class="docutils literal notranslate"><span class="pre">current_step</span></code> and similar.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">screenshot</span></code> is only called a few times in <code class="docutils literal notranslate"><span class="pre">napari-animation</span></code>, so wouldn’t require large changes if asynchronous slicing was the default.</p></li>
</ul>
</li>
<li><p>Decision: always have some way to force synchronous slicing.</p>
<ul>
<li><p>But no need to support synchronous slicing by default, which is harder to implement.</p></li>
</ul>
</li>
</ul>
</li>
<li><p><a class="reference external" href="https://github.com/napari/napari/pull/5052">What should <code class="docutils literal notranslate"><span class="pre">Viewer.screenshot</span></code> do when the canvas is not fully rendered?</a></p>
<ul>
<li><p>Initial consensus is that it should wait for pending slicing tasks and for the associated pushes to vispy.</p>
<ul>
<li><p>There are some ideas of how to implement that, though it is not straightforward.</p></li>
</ul>
</li>
<li><p>In the API, may want a keyword argument to control behavior. In the GUI, could have a dialog if there are pending tasks.
= Decision: want to support both, with blocking behavior as default.</p>
<ul>
<li><p>No need for a design or prototype before acceptance.</p></li>
</ul>
</li>
</ul>
</li>
<li><p>Should <code class="docutils literal notranslate"><span class="pre">Dims.current_step</span></code> (and <code class="docutils literal notranslate"><span class="pre">corner_pixels</span></code>) represent the last slice position request or the last slice response?</p>
<ul>
<li><p>With sync slicing, there is no distinction.</p></li>
<li><p>With async slicing, <code class="docutils literal notranslate"><span class="pre">current</span></code> is ambiguous.</p></li>
<li><p><a class="reference external" href="https://github.com/napari/napari/pull/4892/files#r935336654">Initial small consensus around last request</a></p></li>
<li><p>Decision: last request.</p>
<ul>
<li><p>The implementation is simpler if this represents the last request.</p></li>
<li><p>Can introduce an additional public attribute later if last response is needed.</p></li>
</ul>
</li>
</ul>
</li>
</ul>
</section>
<section id="references-and-footnotes">
<h2>References and footnotes<a class="headerlink" href="#references-and-footnotes" title="Permalink to this headline">¶</a></h2>
<p>All NAPs should be declared as dedicated to the public domain with the CC0
license <a class="footnote-reference brackets" href="#cc0" id="id13">13</a>, as in <code class="docutils literal notranslate"><span class="pre">Copyright</span></code>, below, with attribution encouraged with
CC0+BY <a class="footnote-reference brackets" href="#cc0-by" id="id14">14</a>.</p>
</section>
<section id="copyright">
<h2>Copyright<a class="headerlink" href="#copyright" title="Permalink to this headline">¶</a></h2>
<p>This document is dedicated to the public domain with the Creative Commons CC0
license <a class="footnote-reference brackets" href="#cc0" id="id15">13</a>. Attribution to this source is encouraged where appropriate, as per
CC0+BY <a class="footnote-reference brackets" href="#cc0-by" id="id16">14</a>.</p>
<hr class="footnotes docutils" />
<dl class="footnote brackets">
<dt class="label" id="issue-792"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>napari issue 792, <a class="reference external" href="https://github.com/napari/napari/issues/792">https://github.com/napari/napari/issues/792</a></p>
</dd>
<dt class="label" id="issue-1353"><span class="brackets"><a class="fn-backref" href="#id2">2</a></span></dt>
<dd><p>napari issue 1353, <a class="reference external" href="https://github.com/napari/napari/issues/1353">https://github.com/napari/napari/issues/1353</a></p>
</dd>
<dt class="label" id="issue-1775"><span class="brackets"><a class="fn-backref" href="#id3">3</a></span></dt>
<dd><p>napari issue 1775, <a class="reference external" href="https://github.com/napari/napari/issues/1775">https://github.com/napari/napari/issues/1775</a></p>
</dd>
<dt class="label" id="issue-2156"><span class="brackets"><a class="fn-backref" href="#id4">4</a></span></dt>
<dd><p>napari issue 2156, <a class="reference external" href="https://github.com/napari/napari/issues/2156">https://github.com/napari/napari/issues/2156</a></p>
</dd>
<dt class="label" id="issue-1574"><span class="brackets"><a class="fn-backref" href="#id5">5</a></span></dt>
<dd><p>napari issue 1574, <a class="reference external" href="https://github.com/napari/napari/issues/1574">https://github.com/napari/napari/issues/1574</a></p>
</dd>
<dt class="label" id="pull-4334"><span class="brackets"><a class="fn-backref" href="#id6">6</a></span></dt>
<dd><p>napari pull request 4334, <a class="reference external" href="https://github.com/napari/napari/pull/4334">https://github.com/napari/napari/pull/4334</a></p>
</dd>
<dt class="label" id="slice-class-diagram"><span class="brackets"><a class="fn-backref" href="#id7">7</a></span></dt>
<dd><p>napari slicing class and state dependency diagram, <a class="reference external" href="https://raw.githubusercontent.com/andy-sweet/napari-diagrams/main/napari-slicing-classes.drawio.svg">https://raw.githubusercontent.com/andy-sweet/napari-diagrams/main/napari-slicing-classes.drawio.svg</a></p>
</dd>
<dt class="label" id="vispy-faq-threads"><span class="brackets"><a class="fn-backref" href="#id8">8</a></span></dt>
<dd><p>Vispy FAQs: Is VisPy multi-threaded or thread-safe?, <a class="reference external" href="https://vispy.org/faq.html#is-vispy-multi-threaded-or-thread-safe">https://vispy.org/faq.html#is-vispy-multi-threaded-or-thread-safe</a></p>
</dd>
<dt class="label" id="tracking-issue"><span class="brackets"><a class="fn-backref" href="#id9">9</a></span></dt>
<dd><p>The tracking issue for this work, <a class="reference external" href="https://github.com/napari/napari/issues/4795">https://github.com/napari/napari/issues/4795</a></p>
</dd>
<dt class="label" id="prototype-pr"><span class="brackets"><a class="fn-backref" href="#id10">10</a></span></dt>
<dd><p>A PR that implements a prototype for the approach described here, <a class="reference external" href="https://github.com/andy-sweet/napari/pull/21">https://github.com/andy-sweet/napari/pull/21</a></p>
</dd>
<dt class="label" id="issue-2862"><span class="brackets"><a class="fn-backref" href="#id11">11</a></span></dt>
<dd><p>napari issue 2862, <a class="reference external" href="https://github.com/napari/napari/issues/2862">https://github.com/napari/napari/issues/2862</a></p>
</dd>
<dt class="label" id="pull-4969"><span class="brackets"><a class="fn-backref" href="#id12">12</a></span></dt>
<dd><p>napari pull request 4969, <a class="reference external" href="https://github.com/napari/napari/issues/4969">https://github.com/napari/napari/issues/4969</a></p>
</dd>
<dt class="label" id="cc0"><span class="brackets">13</span><span class="fn-backref">(<a href="#id13">1</a>,<a href="#id15">2</a>)</span></dt>
<dd><p>CC0 1.0 Universal (CC0 1.0) Public Domain Dedication, <a class="reference external" href="https://creativecommons.org/publicdomain/zero/1.0/">https://creativecommons.org/publicdomain/zero/1.0/</a></p>
</dd>
<dt class="label" id="cc0-by"><span class="brackets">14</span><span class="fn-backref">(<a href="#id14">1</a>,<a href="#id16">2</a>)</span></dt>
<dd><p>CO0+BY, <a class="reference external" href="https://dancohen.org/2013/11/26/cc0-by/">https://dancohen.org/2013/11/26/cc0-by/</a></p>
</dd>
</dl>
</section>
</section>


            </div>
            
            
            <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="3-spaces.html" title="previous page">
        <svg
            width="10"
            height="16"
            viewBox="0 0 10 16"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
        >
            <path
                d="M8.92892 1L1.85786 8.07107L8.92892 15.1421"
                stroke="black"
                stroke-width="2"
            />
        </svg>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">NAP-3 — Spaces</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="5-new-logo.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">NAP-5 — New logo (2022)</p>
    </div>

    <svg
        width="10"
        height="16"
        viewBox="0 0 10 16"
        fill="none"
        xmlns="http://www.w3.org/2000/svg"
    >
        <path
            d="M1.07108 15L8.14214 7.92893L1.07108 0.857864"
            stroke="black"
            stroke-width="2"
        />
    </svg>
    </a>
</div>
            
        </main>
        

    </div>

    <script src="../_static/scripts/napari-sphinx-theme.js"></script><footer class="napari-footer">
  
    <div class="footer-item">
      <a href="/">
  <svg
  width="30"
  height="30"
  viewBox="0 0 30 30"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M27.8387 0H2.16127C0.967636 0 0 0.967636 0 2.16127V27.8387C0 29.0324 0.967636 30 2.16127 30H27.8387C29.0324 30 30 29.0324 30 27.8387V2.16127C30 0.967636 29.0324 0 27.8387 0Z"
    fill="#26283D"
  ></path>
  <path
    d="M27.7779 1.03139H2.22356C1.56514 1.03139 1.03139 1.56514 1.03139 2.22357V27.7779C1.03139 28.4363 1.56514 28.9701 2.22356 28.9701H27.7779C28.4363 28.9701 28.9701 28.4363 28.9701 27.7779V2.22357C28.9701 1.56514 28.4363 1.03139 27.7779 1.03139Z"
    fill="url(#paint0_radial)"
  ></path>
  <path
    d="M17.4655 27.3361C17.099 27.3361 16.7542 27.3201 16.4124 27.2897C16.0096 27.2645 15.61 27.202 15.2187 27.1028C14.4296 26.8759 13.6918 26.4986 13.0459 25.9918C12.1394 25.2971 11.3826 24.4265 10.8209 23.4322C10.5949 23.0338 10.3863 22.4775 9.83293 20.9899C9.71125 20.661 9.61999 20.4104 9.54321 20.2091C9.36359 19.7209 9.3042 19.5558 9.15789 19.2385C8.96705 18.7853 8.73274 18.3516 8.45823 17.9435C8.12277 17.4768 7.73384 17.0509 7.29937 16.6745C7.13279 16.5297 7.05601 16.4616 6.91405 16.3515C6.73732 16.2067 6.49396 16.0183 6.02752 15.6098C5.2395 14.9174 4.94254 14.5958 4.66876 14.2453C4.25597 13.7417 3.92726 13.1748 3.69532 12.5664C3.49242 12.0272 3.37416 11.4599 3.34476 10.8846C3.32978 10.3829 3.38289 9.88145 3.50265 9.39401C3.69467 8.45513 4.01235 7.54642 4.44713 6.69241C4.7481 6.05734 5.13833 5.46858 5.60599 4.94398C6.16001 4.34736 6.8007 3.83754 7.50652 3.43167C7.8302 3.24114 8.16941 3.07832 8.52052 2.94495C9.04221 2.75721 9.59283 2.66258 10.1473 2.66537C10.6436 2.66652 11.1376 2.73375 11.6161 2.86528C12.5756 3.10049 13.433 3.64024 14.0599 4.40366C14.7204 5.22066 14.987 6.2477 15.2028 7.63978C15.2578 8.00193 15.2796 8.18879 15.2984 8.35248C15.31 8.46547 15.323 8.57846 15.352 8.77836C15.5273 9.97199 15.6142 10.5167 15.8141 10.9324C16.1038 11.5408 16.6572 11.8957 17.0208 12.1304C17.9131 12.7098 18.8344 12.788 19.4442 12.8416C19.6847 12.8633 19.9585 12.8749 20.2569 12.8749C20.703 12.8749 21.0739 12.8503 21.2115 12.8402C21.4853 12.8199 21.7141 12.7938 21.9358 12.7677C22.272 12.7223 22.6106 12.6972 22.9498 12.6924C23.3746 12.6921 23.7976 12.7491 24.2071 12.8619C25.0966 13.067 25.8989 13.547 26.5002 14.2337C27.1101 14.958 27.2738 15.6721 27.4795 16.5804C27.6193 17.187 27.707 17.8044 27.7417 18.4259C27.7764 19.1313 27.8242 20.0946 27.4925 21.2303C27.1727 22.2747 26.6228 23.234 25.8831 24.0377C25.1073 24.908 24.1734 25.6233 23.1309 26.1453C22.5393 26.4354 21.9207 26.6669 21.2839 26.8363C20.4006 27.0835 19.4935 27.2365 18.578 27.2926C18.1912 27.3216 17.8175 27.3361 17.4655 27.3361Z"
    fill="#26283D"
  ></path>
  <path
    d="M17.4655 26.2265C17.1323 26.2265 16.8194 26.2134 16.5109 26.1859C16.1688 26.1658 15.8293 26.1139 15.4969 26.0309C14.8468 25.8412 14.2394 25.5279 13.7079 25.1082C12.924 24.5046 12.2698 23.7494 11.7842 22.8875C11.6016 22.5645 11.3873 21.9908 10.8701 20.6031C10.7484 20.2786 10.6586 20.0323 10.5804 19.8295C10.4008 19.3385 10.3269 19.1342 10.1618 18.7764C9.94359 18.2639 9.6768 17.7735 9.36504 17.3119C8.98218 16.7792 8.53831 16.293 8.04249 15.8633C7.84694 15.6852 7.74264 15.6026 7.59778 15.4882C7.41961 15.3433 7.19942 15.1738 6.75471 14.7842C6.03042 14.1497 5.76968 13.8672 5.53791 13.5703C5.19569 13.1552 4.92274 12.6875 4.7296 12.1854C4.41134 11.3736 4.36059 10.4814 4.58474 9.63882C4.75558 8.79295 5.04066 7.97424 5.43216 7.20521C5.68904 6.6581 6.02321 6.15074 6.42443 5.69869C6.89941 5.18449 7.44931 4.74497 8.05553 4.39498C8.32534 4.23625 8.6078 4.1001 8.90005 3.98793C9.29948 3.84394 9.72125 3.77185 10.1458 3.77499C10.5448 3.77727 10.9417 3.83182 11.3264 3.93723C12.0597 4.10871 12.7166 4.51577 13.1965 5.09609C13.6311 5.6422 13.8846 6.37663 14.1062 7.80492C14.1584 8.14389 14.1772 8.31048 14.1946 8.47127C14.2076 8.5944 14.2221 8.71753 14.254 8.93481C14.4336 10.1531 14.5321 10.8252 14.8146 11.4104C15.2492 12.2984 15.9734 12.7735 16.4182 13.056C17.5394 13.7803 18.6692 13.8817 19.3443 13.9425C19.6166 13.9672 19.9237 13.9788 20.2554 13.9788C20.7393 13.9788 21.142 13.9527 21.2941 13.9411C21.5838 13.9194 21.8387 13.8904 22.0604 13.8643C22.3529 13.8246 22.6474 13.8019 22.9425 13.7962C23.2691 13.7958 23.5942 13.8401 23.9087 13.9281C24.2796 14.028 25.0502 14.238 25.647 14.9421C26.0816 15.4592 26.2062 16.001 26.393 16.8252C26.5186 17.3689 26.5976 17.9223 26.6292 18.4795C26.661 19.14 26.7016 19.9614 26.422 20.9174C26.1469 21.8088 25.6746 22.6267 25.0401 23.3105C24.3582 24.0719 23.5378 24.6968 22.6224 25.1516C22.0928 25.4117 21.5387 25.6184 20.9681 25.7687C20.1555 25.9947 19.3214 26.1345 18.4795 26.1859C18.1333 26.2192 17.7929 26.2265 17.4655 26.2265Z"
    fill="#A59678"
  ></path>
  <path
    d="M9.21149 4.83535C10.0328 4.53405 10.8513 4.74409 11.0946 4.80783C11.6453 4.93454 12.1384 5.24019 12.4969 5.67697C12.8199 6.07533 13.0212 6.69098 13.2211 7.95558C13.3124 8.5437 13.295 8.56978 13.366 9.07823C13.5529 10.3472 13.6644 11.1062 14.0077 11.816C14.548 12.9314 15.4563 13.521 15.9329 13.8267C17.2366 14.6726 18.5403 14.7885 19.2646 14.8537C19.9624 14.9053 20.663 14.9053 21.3607 14.8537C22.4718 14.7711 22.9121 14.6045 23.6712 14.8117C24.0058 14.9015 24.549 15.0579 24.9546 15.536C25.2443 15.8851 25.337 16.2603 25.5109 17.0324C25.625 17.5246 25.6967 18.0257 25.7253 18.5302C25.7571 19.169 25.7904 19.86 25.5543 20.6697C25.3157 21.4363 24.906 22.1387 24.3563 22.7238C23.7531 23.3969 23.027 23.9485 22.2168 24.3491C21.736 24.5834 21.2327 24.7683 20.7146 24.901C19.9602 25.1106 19.1857 25.2397 18.4042 25.2863C17.7992 25.3373 17.1911 25.3373 16.5862 25.2863C16.2975 25.2698 16.0109 25.2267 15.7301 25.1574C15.1926 24.9997 14.6912 24.7384 14.254 24.3882C13.5654 23.8599 12.9908 23.1976 12.5649 22.4413C12.4201 22.1806 12.1811 21.5476 11.7088 20.2801C11.2916 19.1603 11.2323 18.943 10.9845 18.3969C10.7451 17.8345 10.451 17.297 10.1067 16.7919C9.68854 16.2019 9.20233 15.6632 8.65814 15.1869C8.19314 14.7639 8.16417 14.8044 7.35442 14.0961C6.64751 13.4761 6.43168 13.2342 6.25205 13.0053C5.96697 12.6629 5.73947 12.2764 5.57846 11.8609C5.45202 11.5217 5.37825 11.1651 5.35973 10.8035C5.35202 10.4734 5.39004 10.1439 5.47272 9.82425C5.62675 9.05475 5.88556 8.31001 6.24191 7.61082C6.46342 7.13752 6.75173 6.69847 7.09802 6.3071C7.32105 6.06667 7.56328 5.84479 7.82231 5.64366C8.03967 5.47474 8.26863 5.3213 8.50748 5.18446C8.73275 5.05002 8.96813 4.93329 9.21149 4.83535V4.83535Z"
    fill="url(#paint1_linear)"
  ></path>
  <defs>
    <radialGradient
      id="paint0_radial"
      cx="0"
      cy="0"
      r="1"
      gradientUnits="userSpaceOnUse"
      gradientTransform="translate(15 15) scale(28.521)"
    >
      <stop stop-color="#746B7F"></stop>
      <stop offset="0.12" stop-color="#615B6F"></stop>
      <stop offset="0.26" stop-color="#514C60"></stop>
      <stop offset="0.37" stop-color="#4B475B"></stop>
      <stop offset="0.44" stop-color="#4F4B5F"></stop>
      <stop offset="0.51" stop-color="#5A566C"></stop>
      <stop offset="0.59" stop-color="#6D6881"></stop>
      <stop offset="0.67" stop-color="#87829E"></stop>
      <stop offset="0.74" stop-color="#A9A2C3"></stop>
      <stop offset="0.78" stop-color="#BCB5D9"></stop>
    </radialGradient>
    <linearGradient
      id="paint1_linear"
      x1="5.54949"
      y1="7.79624"
      x2="23.9884"
      y2="23.7393"
      gradientUnits="userSpaceOnUse"
    >
      <stop offset="0.05" stop-color="#448491"></stop>
      <stop offset="0.15" stop-color="#4A7986"></stop>
      <stop offset="0.33" stop-color="#506E7B"></stop>
      <stop offset="0.52" stop-color="#526A77"></stop>
      <stop offset="0.6" stop-color="#56707C"></stop>
      <stop offset="0.7" stop-color="#607F8B"></stop>
      <stop offset="0.82" stop-color="#7099A3"></stop>
      <stop offset="0.94" stop-color="#87BDC4"></stop>
      <stop offset="1" stop-color="#94D1D6"></stop>
    </linearGradient>
  </defs>
</svg>
  <span>napari</span>
</a>

<a class="footer-icon__hover-blue" href="https://napari-hub.org" target="_blank" rel="noreferrer">
  <svg
  class="footer-icon__regular"
  width="487"
  height="512"
  viewBox="0 0 487 512"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <title>Visit napari hub</title>
  <circle
    cx="243.036"
    cy="256"
    r="85.3333"
    fill="white"
    stroke="white"
    stroke-width="56.8889"
  ></circle>
  <circle cx="243.036" cy="42.6667" r="42.6667" fill="white"></circle>
  <circle cx="243.036" cy="469.333" r="42.6667" fill="white"></circle>
  <path
    d="M243.036 28.4444L243.036 142.222"
    stroke="white"
    stroke-width="56.8889"
    stroke-linecap="round"
    stroke-linejoin="round"
  ></path>
  <path
    d="M243.036 369.778L243.036 483.556"
    stroke="white"
    stroke-width="56.8889"
    stroke-linecap="round"
    stroke-linejoin="round"
  ></path>
  <circle
    cx="58.2838"
    cy="149.333"
    r="42.6667"
    transform="rotate(-60 58.2838 149.333)"
    fill="white"
  ></circle>
  <circle
    cx="427.788"
    cy="362.667"
    r="42.6667"
    transform="rotate(-60 427.788 362.667)"
    fill="white"
  ></circle>
  <path
    d="M45.967 142.222L144.501 199.111"
    stroke="white"
    stroke-width="56.8889"
    stroke-linecap="round"
    stroke-linejoin="round"
  ></path>
  <path
    d="M341.57 312.889L440.105 369.778"
    stroke="white"
    stroke-width="56.8889"
    stroke-linecap="round"
    stroke-linejoin="round"
  ></path>
  <circle
    cx="58.2838"
    cy="362.667"
    r="42.6667"
    transform="rotate(-120 58.2838 362.667)"
    fill="white"
  ></circle>
  <circle
    cx="427.788"
    cy="149.333"
    r="42.6667"
    transform="rotate(-120 427.788 149.333)"
    fill="white"
  ></circle>
  <path
    d="M45.967 369.778L144.501 312.889"
    stroke="white"
    stroke-width="56.8889"
    stroke-linecap="round"
    stroke-linejoin="round"
  ></path>
  <path
    d="M341.57 199.111L440.105 142.222"
    stroke="white"
    stroke-width="56.8889"
    stroke-linecap="round"
    stroke-linejoin="round"
  ></path>
</svg>
  <svg
  class="footer-icon__light-blue"
  width="17"
  height="17"
  viewBox="0 0 17 17"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <g clip-path="url(#clip0_307_186)">
    <circle
      cx="8.50002"
      cy="8.49935"
      r="2.83333"
      fill="#D2EFFF"
      stroke="#D2EFFF"
      stroke-width="1.86421"
    />
    <circle cx="8.50004" cy="1.41667" r="1.41667" fill="#D2EFFF" />
    <circle cx="8.50004" cy="15.5846" r="1.41667" fill="#D2EFFF" />
    <path
      d="M8.50006 0.943359L8.50006 4.72114"
      stroke="#D2EFFF"
      stroke-width="1.86421"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M8.50006 12.2773L8.50006 16.0551"
      stroke="#D2EFFF"
      stroke-width="1.86421"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <circle
      cx="2.36574"
      cy="4.95803"
      r="1.41667"
      transform="rotate(-60 2.36574 4.95803)"
      fill="#D2EFFF"
    />
    <circle
      cx="14.6344"
      cy="12.0401"
      r="1.41667"
      transform="rotate(-60 14.6344 12.0401)"
      fill="#D2EFFF"
    />
    <path
      d="M1.95673 4.72266L5.22838 6.61155"
      stroke="#D2EFFF"
      stroke-width="1.86421"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M11.7717 10.3887L15.0434 12.2776"
      stroke="#D2EFFF"
      stroke-width="1.86421"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <circle
      cx="2.3657"
      cy="12.0433"
      r="1.41667"
      transform="rotate(-120 2.3657 12.0433)"
      fill="#D2EFFF"
    />
    <circle
      cx="14.6345"
      cy="4.95933"
      r="1.41667"
      transform="rotate(-120 14.6345 4.95933)"
      fill="#D2EFFF"
    />
    <path
      d="M1.95673 12.2773L5.22838 10.3885"
      stroke="#D2EFFF"
      stroke-width="1.86421"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
    <path
      d="M11.7717 6.61133L15.0434 4.72244"
      stroke="#D2EFFF"
      stroke-width="1.86421"
      stroke-linecap="round"
      stroke-linejoin="round"
    />
  </g>
  <defs>
    <clipPath id="clip0_307_186">
      <rect width="17" height="17" fill="white" />
    </clipPath>
  </defs>
</svg>
  <span>napari hub</span>
</a>

<a class="footer-icon__hover-blue" href="https://github.com/napari/napari" target="_blank" rel="noreferrer">
  <svg
  class="footer-icon__regular"
  width="14"
  height="14"
  viewBox="0 0 14 14"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <title>Visit GitHub repository</title>
  <path
    d="M7 0.173252C3.1325 0.173252 0 3.3075 0 7.17325C0 10.2667 2.0055 12.8899 4.78625 13.8145C5.13625 13.8804 5.26458 13.664 5.26458 13.4779C5.26458 13.3117 5.25875 12.8713 5.25583 12.2879C3.30867 12.7103 2.898 11.3488 2.898 11.3488C2.5795 10.5408 2.11925 10.325 2.11925 10.325C1.48517 9.891 2.16825 9.89975 2.16825 9.89975C2.87117 9.94875 3.24042 10.6208 3.24042 10.6208C3.86458 11.6912 4.879 11.382 5.27917 11.2029C5.34217 10.7503 5.52242 10.4417 5.7225 10.2667C4.16792 10.0917 2.534 9.48967 2.534 6.8075C2.534 6.04334 2.80525 5.41917 3.25442 4.92917C3.17567 4.75242 2.93942 4.04075 3.31567 3.0765C3.31567 3.0765 3.90192 2.88867 5.24067 3.794C5.80067 3.63825 6.39567 3.56125 6.99067 3.55775C7.58567 3.56125 8.18067 3.63825 8.74067 3.794C10.0707 2.88867 10.6569 3.0765 10.6569 3.0765C11.0332 4.04075 10.7969 4.75242 10.7269 4.92917C11.1732 5.41917 11.4444 6.04334 11.4444 6.8075C11.4444 9.49667 9.80817 10.0888 8.25067 10.2608C8.49567 10.4708 8.72317 10.9002 8.72317 11.5558C8.72317 12.4927 8.71442 13.2452 8.71442 13.4727C8.71442 13.6564 8.83692 13.8752 9.19567 13.8052C11.9962 12.887 14 10.262 14 7.17325C14 3.3075 10.8657 0.173252 7 0.173252Z"
    fill="white"
  ></path>
</svg>
  <svg
  class="footer-icon__light-blue"
  width="16"
  height="16"
  viewBox="0 0 16 16"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M8 0C3.58 0 0 3.582 0 8C0 11.5353 2.292 14.5333 5.47 15.59C5.87 15.6653 6.01667 15.418 6.01667 15.2053C6.01667 15.0153 6.01 14.512 6.00667 13.8453C3.78133 14.328 3.312 12.772 3.312 12.772C2.948 11.8487 2.422 11.602 2.422 11.602C1.69733 11.106 2.478 11.116 2.478 11.116C3.28133 11.172 3.70333 11.94 3.70333 11.94C4.41667 13.1633 5.576 12.81 6.03333 12.6053C6.10533 12.088 6.31133 11.7353 6.54 11.5353C4.76333 11.3353 2.896 10.6473 2.896 7.582C2.896 6.70867 3.206 5.99533 3.71933 5.43533C3.62933 5.23333 3.35933 4.42 3.78933 3.318C3.78933 3.318 4.45933 3.10333 5.98933 4.138C6.62933 3.96 7.30933 3.872 7.98933 3.868C8.66933 3.872 9.34933 3.96 9.98933 4.138C11.5093 3.10333 12.1793 3.318 12.1793 3.318C12.6093 4.42 12.3393 5.23333 12.2593 5.43533C12.7693 5.99533 13.0793 6.70867 13.0793 7.582C13.0793 10.6553 11.2093 11.332 9.42933 11.5287C9.70933 11.7687 9.96933 12.2593 9.96933 13.0087C9.96933 14.0793 9.95933 14.9393 9.95933 15.1993C9.95933 15.4093 10.0993 15.6593 10.5093 15.5793C13.71 14.53 16 11.53 16 8C16 3.582 12.418 0 8 0"
    fill="#D2EFFF"
  />
</svg>
  <span>GitHub</span>
</a>

<a class="footer-icon__hover-blue" href="https://twitter.com/napari_imaging" target="_blank" rel="noreferrer">
  <svg
  class="footer-icon__regular"
  width="15"
  height="13"
  viewBox="0 0 15 13"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <title>Visit Twitter page</title>
  <path
    d="M13.4581 3.44478C13.4676 3.57802 13.4676 3.7113 13.4676 3.84454C13.4676 7.9086 10.3744 12.5914 4.72082 12.5914C2.97906 12.5914 1.36105 12.0869 7.62939e-06 11.2113C0.247478 11.2398 0.485398 11.2494 0.742391 11.2494C2.17955 11.2494 3.50254 10.764 4.55901 9.93591C3.20749 9.90735 2.07487 9.0222 1.68464 7.80392C1.87501 7.83246 2.06535 7.8515 2.26524 7.8515C2.54125 7.8515 2.81728 7.81341 3.07425 7.74682C1.66562 7.46127 0.609119 6.22397 0.609119 4.72968V4.69163C1.01837 4.92006 1.49429 5.06282 1.9987 5.08183C1.17065 4.52979 0.628162 3.58755 0.628162 2.52155C0.628162 1.9505 0.780418 1.42702 1.04693 0.970164C2.56026 2.83564 4.83502 4.05389 7.38575 4.18717C7.33817 3.95874 7.30961 3.72082 7.30961 3.48287C7.30961 1.78869 8.68017 0.40863 10.3838 0.40863C11.269 0.40863 12.0685 0.779822 12.63 1.37944C13.3248 1.2462 13.9911 0.989207 14.5812 0.637058C14.3527 1.35091 13.8673 1.95052 13.2297 2.33121C13.8483 2.26462 14.4479 2.09326 14.9999 1.85534C14.5812 2.46445 14.0577 3.00694 13.4581 3.44478Z"
    fill="white"
  ></path>
</svg>
  <svg
  class="footer-icon__light-blue"
  width="16"
  height="16"
  viewBox="0 0 16 16"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M15.9687 3.04705C15.3697 3.31079 14.7351 3.48488 14.0853 3.56372C14.7694 3.15255 15.2816 2.50775 15.5273 1.74838C14.8933 2.11838 14.1907 2.38772 13.4427 2.53772C12.9492 2.01 12.2952 1.66 11.5824 1.54205C10.8696 1.4241 10.1378 1.54482 9.50062 1.88544C8.86345 2.22607 8.35657 2.76755 8.0587 3.4258C7.76083 4.08405 7.68864 4.82223 7.85333 5.52572C5.12667 5.39705 2.71133 4.08705 1.09333 2.10838C0.799196 2.60826 0.645776 3.1784 0.649333 3.75838C0.649333 4.89838 1.22933 5.90038 2.108 6.48905C1.58724 6.47247 1.07798 6.33167 0.622667 6.07838V6.11838C0.622371 6.87598 0.884179 7.61034 1.36367 8.19689C1.84316 8.78343 2.51081 9.18603 3.25333 9.33638C2.7722 9.4653 2.26828 9.48467 1.77867 9.39305C1.98941 10.0451 2.39844 10.615 2.94868 11.0234C3.49891 11.4318 4.1629 11.6582 4.848 11.671C3.68769 12.5817 2.25498 13.0759 0.78 13.0744C0.52 13.0744 0.260667 13.0591 0 13.0297C1.50381 13.9926 3.25234 14.5037 5.038 14.5024C11.0733 14.5024 14.37 9.50505 14.37 5.17905C14.37 5.03905 14.37 4.89905 14.36 4.75905C15.004 4.29563 15.5595 3.72026 16 3.06038L15.9687 3.04705Z"
    fill="#D2EFFF"
  />
</svg>
  <span>Twitter</span>
</a>

<a class="footer-icon__hover-blue" href="https://forum.image.sc/tag/napari" target="_blank" rel="noreferrer">
  <svg
  class="footer-icon__regular"
  width="20"
  height="20"
  viewBox="0 0 20 20"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <title>Visit image.sc forum</title>
  <path
    d="M12.9987 4.65361V2.01143C12.9987 2.00512 12.9936 2 12.9873 2H6.95296C6.94665 2 6.94153 2.00512 6.94153 2.01143V8.04571C6.94153 8.05203 6.94665 8.05714 6.95296 8.05714H10.9701"
    stroke="white"
    stroke-width="2.34286"
  ></path>
  <path
    d="M6.94153 15.3464V17.9886C6.94153 17.9949 6.94665 18 6.95296 18H12.9873C12.9936 18 12.9987 17.9949 12.9987 17.9886V11.9543C12.9987 11.948 12.9936 11.9429 12.9873 11.9429H8.9701"
    stroke="white"
    stroke-width="2.34286"
  ></path>
  <path
    d="M16.1145 9.9496L18.4027 8.62852C18.4082 8.62536 18.4101 8.61837 18.4069 8.6129L15.3898 3.38706C15.3866 3.38159 15.3796 3.37972 15.3742 3.38288L10.1483 6.40002C10.1429 6.40317 10.141 6.41016 10.1441 6.41563L12.1527 9.89458"
    stroke="white"
    stroke-width="2.34286"
  ></path>
  <path
    d="M3.82577 10.0503L1.53758 11.3714C1.53211 11.3745 1.53024 11.3815 1.5334 11.387L4.55054 16.6128C4.5537 16.6183 4.56069 16.6202 4.56615 16.617L9.792 13.5999C9.79746 13.5967 9.79934 13.5897 9.79618 13.5842L7.78761 10.1053"
    stroke="white"
    stroke-width="2.34286"
  ></path>
  <path
    d="M13.086 15.2962L15.3742 16.6173C15.3796 16.6205 15.3866 16.6186 15.3898 16.6131L18.4069 11.3873C18.4101 11.3818 18.4082 11.3748 18.4027 11.3717L13.1769 8.35456C13.1714 8.35141 13.1644 8.35328 13.1613 8.35875L11.1527 11.8377"
    stroke="white"
    stroke-width="2.34286"
  ></path>
  <path
    d="M6.85434 4.70397L4.56614 3.38288C4.56068 3.37973 4.55369 3.3816 4.55053 3.38707L1.53339 8.61291C1.53023 8.61838 1.53211 8.62537 1.53757 8.62852L6.76342 11.6457C6.76888 11.6488 6.77587 11.647 6.77903 11.6415L8.7876 8.16254"
    stroke="white"
    stroke-width="2.34286"
  ></path>
</svg>
  <svg
  class="footer-icon__light-blue"
  width="16"
  height="16"
  viewBox="0 0 16 16"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <path
    d="M10.3989 3.72445V1.61071C10.3989 1.60566 10.3948 1.60156 10.3898 1.60156H5.56237C5.55732 1.60156 5.55322 1.60566 5.55322 1.61071V6.43813C5.55322 6.44319 5.55732 6.44727 5.56237 6.44727H8.77605"
    stroke="#D2EFFF"
    stroke-width="1.87535"
  />
  <path
    d="M5.55322 12.2794V14.3932C5.55322 14.3982 5.55732 14.4023 5.56237 14.4023H10.3898C10.3948 14.4023 10.3989 14.3982 10.3989 14.3932V9.56576C10.3989 9.56072 10.3948 9.55664 10.3898 9.55664H7.17608"
    stroke="#D2EFFF"
    stroke-width="1.87535"
  />
  <path
    d="M12.8916 7.96164L14.7221 6.90477C14.7265 6.90224 14.728 6.89665 14.7255 6.89228L12.3118 2.7116C12.3092 2.70723 12.3036 2.70573 12.2993 2.70826L8.1186 5.12197C8.11428 5.12449 8.11276 5.13008 8.11524 5.13446L9.72212 7.91762"
    stroke="#D2EFFF"
    stroke-width="1.87535"
  />
  <path
    d="M3.06062 8.04297L1.23007 9.09985C1.22569 9.10233 1.2242 9.10793 1.22672 9.11233L3.64044 13.293C3.64296 13.2974 3.64856 13.2989 3.65292 13.2963L7.8336 10.8826C7.83797 10.8801 7.83948 10.8745 7.83695 10.8701L6.23009 8.08697"
    stroke="#D2EFFF"
    stroke-width="1.87535"
  />
  <path
    d="M10.4688 12.2401L12.2994 13.297C12.3037 13.2996 12.3093 13.298 12.3119 13.2936L14.7255 9.11299C14.7281 9.10859 14.7266 9.10299 14.7222 9.10051L10.5415 6.68677C10.5371 6.68425 10.5315 6.68575 10.5291 6.69012L8.92218 9.47331"
    stroke="#D2EFFF"
    stroke-width="1.87535"
  />
  <path
    d="M5.48348 3.76513L3.65292 2.70825C3.64855 2.70573 3.64296 2.70723 3.64043 2.71161L1.22672 6.89228C1.22419 6.89665 1.2257 6.90225 1.23007 6.90477L5.41075 9.3185C5.41511 9.32098 5.42071 9.31954 5.42323 9.31514L7.03009 6.53198"
    stroke="#D2EFFF"
    stroke-width="1.87535"
  />
</svg>
  <span>image.sc</span>
</a>

<a class="footer-icon__hover-blue" href="https://napari.zulipchat.com" target="_blank" rel="noreferrer">
  <svg
  class="footer-icon__regular"
  width="16"
  height="16"
  viewBox="0 0 16 16"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <title>Visit Zulip chatroom</title>
  <g clip-path="url(#clip0)">
    <path
      d="M15.178 2.39267C15.178 3.19867 14.816 3.91467 14.2647 4.34867L8.90869 9.13133C8.80935 9.21667 8.68002 9.07933 8.75202 8.96467L10.716 5.03133C10.7714 4.92133 10.7 4.786 10.5867 4.786H2.96802C1.78802 4.786 0.822021 3.70933 0.822021 2.39267C0.822021 1.07733 1.78802 3.09431e-07 2.96802 3.09431e-07H13.032C14.212 -0.000666357 15.178 1.076 15.178 2.39267ZM2.96802 16H13.032C14.212 16 15.178 14.9227 15.178 13.6067C15.178 12.2907 14.212 11.2133 13.032 11.2133H5.41335C5.30002 11.2133 5.22869 11.0787 5.28402 10.9687L7.24802 7.03533C7.32002 6.92067 7.19069 6.78333 7.09135 6.86867L1.73602 11.6507C1.18402 12.084 0.822688 12.8007 0.822688 13.6067C0.822688 14.9227 1.78802 16 2.96802 16Z"
      fill="white"
    ></path>
  </g>
  <defs>
    <clipPath id="clip0">
      <rect width="16" height="16" fill="white"></rect>
    </clipPath>
  </defs>
</svg>
  <svg
  class="footer-icon__light-blue"
  width="16"
  height="16"
  viewBox="0 0 16 16"
  fill="none"
  xmlns="http://www.w3.org/2000/svg"
>
  <g clip-path="url(#clip0_307_219)">
    <path
      d="M15.178 2.39267C15.178 3.19867 14.816 3.91467 14.2647 4.34867L8.90866 9.13133C8.80932 9.21667 8.67999 9.07933 8.75199 8.96467L10.716 5.03133C10.7713 4.92133 10.7 4.786 10.5867 4.786H2.96799C1.78799 4.786 0.821991 3.70933 0.821991 2.39267C0.821991 1.07733 1.78799 3.09431e-07 2.96799 3.09431e-07H13.032C14.212 -0.000666357 15.178 1.076 15.178 2.39267V2.39267ZM2.96799 16H13.032C14.212 16 15.178 14.9227 15.178 13.6067C15.178 12.2907 14.212 11.2133 13.032 11.2133H5.41332C5.29999 11.2133 5.22866 11.0787 5.28399 10.9687L7.24799 7.03533C7.31999 6.92067 7.19066 6.78333 7.09132 6.86867L1.73599 11.6507C1.18399 12.084 0.822658 12.8007 0.822658 13.6067C0.822658 14.9227 1.78799 16 2.96799 16V16Z"
      fill="#D2EFFF"
    />
  </g>
  <defs>
    <clipPath id="clip0_307_219">
      <rect width="16" height="16" fill="white" />
    </clipPath>
  </defs>
</svg>
  <span>Zulip</span>
</a>
    </div>
  
    <div class="footer-item">
      <div class="napari-copyright">
  <p class="copyright">
        Copyright 2022, The napari team<br>
  </p>

  <div class="sphinx-version">
    <div class="sphinx-link">
      <span>Created using</span>
      <a href="http://sphinx-doc.org/">Sphinx</a>
    </div>

    
      <span>4.5.0</span>
    
  </div>
</div>
    </div>
  
</footer>
  </body>
</html>